<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darna - Exquisite Custom Sweet Boxes</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Custom Styles -->
    <style>
        :root {
            /* --- Colors and Fonts --- */
            --luxury-dark: #332e2e;
            --luxury-brown: #8a6d5a;
            --luxury-gold: #daa520;
            --luxury-cream: #fdfbf5;
            --luxury-light: #FFFFFF;
            --luxury-accent: #c8b077;
            --luxury-success: #5a7d3c;
            --font-heading: 'Playfair Display', serif;
            --font-body: 'Lato', sans-serif;
            --transition-speed-fast: 0.25s;
            --transition-speed-med: 0.4s;
            --transition-speed-slow: 0.6s;
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.06);
            --shadow-medium: 0 6px 16px rgba(0, 0, 0, 0.08);
            --shadow-strong: 0 8px 24px rgba(0, 0, 0, 0.10);
        }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOutDown { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(12px); } }
        @keyframes slideInRight { from { transform: translateX(25px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-25px); opacity: 0; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes shrinkOutFade { from { transform: scale(1); opacity: 1; } to { transform: scale(0.95); opacity: 0; } }
        @keyframes pulseSubtle { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        @keyframes checkmarkFadeIn { from { opacity: 0; transform: scale(0.7); } to { opacity: 1; transform: scale(1); } }

        /* --- Base & Body --- */
        body {
            background: linear-gradient(180deg, var(--luxury-cream) 0%, #f7f3eb 100%);
            font-family: var(--font-body);
            color: var(--luxury-dark);
            margin: 0;
            padding-top: 65px; /* Further reduced */
            font-size: 14px; /* Base for desktop, adjusted down for mobile */
            animation: fadeIn var(--transition-speed-slow) ease-out;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Navbar --- */
        .navbar { background-color: var(--luxury-dark); box-shadow: 0 3px 10px rgba(0, 0, 0, 0.18); padding: 0.4rem 1rem; /* Reduced padding */ }
        .navbar .navbar-brand img { max-width: 130px; /* Smaller logo */ height: auto; transition: transform var(--transition-speed-fast) ease; }
        .navbar .navbar-brand:hover img { transform: scale(1.04); }
        .navbar .nav-link { color: var(--luxury-cream) !important; font-weight: 400; text-transform: uppercase; letter-spacing: 0.6px; font-size: 0.75em; margin: 0 0.3rem; transition: color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease; position: relative; padding-bottom: 3px; }
        .navbar .nav-link::after { content: ''; position: absolute; bottom: 0px; left: 50%; transform: translateX(-50%); width: 0; height: 1.5px; background-color: var(--luxury-gold); transition: width var(--transition-speed-fast) ease; }
        .navbar .nav-link:hover::after, .navbar .nav-link.active::after { width: 45%; }
        .navbar .nav-link:hover, .navbar .nav-link.active { color: var(--luxury-gold) !important; transform: translateY(-1px); }
        .navbar-toggler { padding: .2rem .4rem; font-size: 0.8rem; border-color: rgba(255,255,255,0.15); }
        .navbar-toggler-icon { width: 1.0em; height: 1.0em; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.85%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='3' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e"); } /* Thicker lines */
        /* Mobile Cart Indicator - Hidden by default */
        #nav-cart-indicator {
             display: none; /* Hidden on desktop */
             color: var(--luxury-cream);
             font-size: 1.4em; /* Icon size */
             position: relative;
             margin-right: 0.75rem; /* Space before toggler */
             cursor: default; /* Indicate it's not clickable (yet) */
         }
         #nav-cart-indicator .badge {
             position: absolute;
             top: -5px;
             right: -10px;
             font-size: 0.6em;
             padding: 2px 4px;
             line-height: 1;
             background-color: var(--luxury-gold);
             color: var(--luxury-dark);
             border-radius: 50%;
         }


        /* --- Main Content Area --- */
        .main-container { padding-top: 1.8rem; padding-bottom: 1.8rem; } /* Reduced padding */

        /* --- Main Title & Wizard Progress --- */
        .main-title { font-family: var(--font-heading); font-style: italic; color: var(--luxury-brown); font-size: 2.2em; text-align: center; margin-bottom: 1.5rem; animation: fadeInUp 1s ease-out 0.2s backwards; }
        #wizard-progress { display: flex; justify-content: space-around; margin-bottom: 1.8rem; padding: 9px 5px; background-color: rgba(255, 255, 255, 0.8); border-radius: 50px; box-shadow: var(--shadow-soft); max-width: 600px; margin-left: auto; margin-right: auto; animation: fadeInUp 1s ease-out 0.4s backwards; }
        .progress-step { text-align: center; color: var(--luxury-brown); opacity: 0.6; font-weight: 600; font-size: 0.7em; flex: 1; padding: 5px 2px; border-bottom: 2px solid transparent; transition: all var(--transition-speed-med) ease-out; cursor: default; position: relative; line-height: 1.2; }
        .progress-step span { display: inline-block; margin-right: 2px;}
        .progress-step .step-text { display: inline; } /* Text description */
        .progress-step::after { display: none; }
        .progress-step.active { color: var(--luxury-gold); opacity: 1; border-bottom-color: var(--luxury-gold); transform: scale(1.03); }
        .progress-step.completed { color: var(--luxury-accent); opacity: 1; cursor: pointer; }
        .progress-step.completed::before { content: '✓'; margin-right: 2px; color: var(--luxury-accent); display: inline-block; animation: checkmarkFadeIn 0.4s ease-out; }
        .progress-step:not(.active):hover { opacity: 0.9; transform: translateY(-1px); }

        /* --- Wizard Steps --- */
        #wizard { max-width: 700px; /* Reduced width */ margin: 15px auto 30px auto; position: relative; overflow: visible; min-height: 360px; }
        .step {
            position: absolute; top: 0; left: 0; width: 100%;
            opacity: 0; visibility: hidden;
            display: flex; flex-direction: column;
            height: 100%; max-height: 70vh; /* Limit height */
            border: 1px solid rgba(0, 0, 0, 0.03); border-radius: 12px; /* Softer radius */
            margin-bottom: 25px; background: linear-gradient(155deg, var(--luxury-light), #fdfaf7);
            box-shadow: var(--shadow-medium);
            transition: opacity var(--transition-speed-med) ease-out, transform var(--transition-speed-med) ease-out, visibility var(--transition-speed-med);
            transform: translateX(25px);
        }
        .step.active-step { display: flex; position: relative; opacity: 1; visibility: visible; transform: translateX(0); z-index: 10; }
        .step.exiting-step { transform: translateX(-25px); }

        /* Scrollable content area WITHIN the step */
        .step-scrollable-content {
            padding: 18px 22px; /* Reduced padding */
            overflow-y: auto;
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--luxury-accent) rgba(0,0,0,0.05);
        }
        .step-scrollable-content::-webkit-scrollbar { width: 5px; } /* Thinner scrollbar */
        .step-scrollable-content::-webkit-scrollbar-track { background: rgba(0,0,0,0.03); border-radius: 2.5px; }
        .step-scrollable-content::-webkit-scrollbar-thumb { background-color: var(--luxury-accent); border-radius: 2.5px; border: 1px solid transparent; background-clip: content-box; }
        .step-scrollable-content::-webkit-scrollbar-thumb:hover { background-color: var(--luxury-gold); }

        .step-scrollable-content h2 { font-family: var(--font-heading); color: var(--luxury-brown); text-align: center; font-weight: 700; margin-top: 0; margin-bottom: 1.4rem; font-size: 1.55em; } /* Smaller heading */

        .step .form-check { margin-bottom: 0.8rem; font-size: 0.88em; padding-left: 1.8em; }
        .step .form-check-label { cursor: pointer; color: var(--luxury-dark); font-weight: 400; transition: color var(--transition-speed-fast) ease; }
        .step .form-check-input { cursor: pointer; border-color: #c8b077b8; transition: background-color var(--transition-speed-fast) ease, border-color var(--transition-speed-fast) ease; height: 0.95em; width: 0.95em; margin-top: 0.18em; }
        .step .form-check-input:checked { background-color: var(--luxury-gold); border-color: var(--luxury-gold); }
        .step .form-check-input:focus { box-shadow: 0 0 0 0.15rem rgba(218, 165, 32, 0.2); }
        .step .form-check:hover .form-check-label { color: var(--luxury-gold); }
        .step button { font-family: var(--font-body); font-weight: 600; padding: 7px 18px; border: none; border-radius: 50px; cursor: pointer; transition: all var(--transition-speed-fast) ease; box-shadow: var(--shadow-soft); letter-spacing: 0.4px; text-transform: uppercase; font-size: 0.72em; } /* Smaller buttons */
        .step button:hover { box-shadow: var(--shadow-medium); transform: translateY(-2px); }
        .step button:active { transform: translateY(0px) scale(0.98); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .step .btn-primary { background: linear-gradient(100deg, var(--luxury-gold), var(--luxury-accent)); color: var(--luxury-light); }
        .step .btn-primary:hover { background: linear-gradient(100deg, var(--luxury-accent), var(--luxury-gold)); }
        .step .btn-secondary { background-color: #f5f5f5; color: #555; border: 1px solid #e8e8e8; }
        .step .btn-secondary:hover { background-color: #e9e9e9; }
        .step .btn-success { background-color: var(--luxury-success); color: var(--luxury-light); }
        .step .btn-success:hover { background-color: #4a6b2a; }

        /* Button Group fixed at the bottom */
        .button-group {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: auto;
            padding: 0.8rem 22px; /* Reduced padding */
            border-top: 1px solid rgba(0,0,0,0.05);
            background-color: #fdfaf7;
            border-bottom-left-radius: 12px; /* Match step radius */
             border-bottom-right-radius: 12px;
             flex-shrink: 0;
        }
        #quantityStep .prevStep { visibility: hidden; }
        #reviewStep .nextStep { display: none; }
        #quantityStep .button-group { justify-content: flex-end; }


        /* --- Sweet Card Styling --- */
        .sweet-card-column { margin-bottom: 12px; } /* Reduced margin */
        .sweet-card { border: 1px solid transparent; border-radius: 7px; /* Sharper radius */ overflow: hidden; box-shadow: var(--shadow-soft); transition: transform var(--transition-speed-fast) ease, box-shadow var(--transition-speed-fast) ease, border-color var(--transition-speed-fast) ease; background-color: var(--luxury-light); animation: fadeInUp var(--transition-speed-med) ease-out backwards; height: 100%; display: flex; flex-direction: column; max-width: 200px; /* Further reduced max-width */ margin-left: auto; margin-right: auto; cursor: default; }
        .sweet-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-medium); }
        .sweet-card.card-in-cart { border-color: var(--luxury-gold); background-color: #fffdf7; }
        .sweet-card img { width: 100%; aspect-ratio: 16 / 11; object-fit: cover; border-bottom: 1px solid rgba(0,0,0,0.04); background-color: #f8f8f8; cursor: pointer; }
        .sweet-card .card-body { padding: 8px; display: flex; flex-direction: column; flex-grow: 1; }
        .sweet-card .card-title { font-family: var(--font-heading); font-size: 0.9em; color: var(--luxury-brown); margin-bottom: 2px; }
        .sweet-variations { font-size: 0.58em; color: var(--luxury-accent); margin-bottom: 4px; opacity: 0.9; font-weight: 400; line-height: 1.25; }
        .sweet-variations i { margin-right: 2px; font-size: 0.85em; vertical-align: middle; opacity: 0.8; }
        .sweet-card .card-text { font-size: 0.7em; color: #707070; line-height: 1.3; flex-grow: 1; margin-bottom: 5px; max-height: 35px; /* Reduced height */ overflow: hidden; }
        .sweet-card .form-group { margin-top: auto; }
        /* Quantity Control Styling */
        .quantity-control-wrapper label { font-size: 0.6em; margin-bottom: 2px; font-weight: 600; color: var(--luxury-accent); text-transform: uppercase; letter-spacing: 0.3px; display: block; }
        .quantity-control { display: flex; align-items: center; justify-content: space-between; border: 1px solid #e5e5e5; border-radius: 12px; overflow: hidden; background-color: #fff; max-width: 90px; /* Smaller control */ margin-left: auto; margin-right: auto; }
        .quantity-control .btn-qty { background-color: #f9f9f9; border: none; color: var(--luxury-brown); font-size: 1.0em; font-weight: 500; line-height: 1; padding: 3px 7px; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; }
        .quantity-control .btn-qty:hover { background-color: #eee; color: var(--luxury-dark); }
        .quantity-control .btn-qty:active { background-color: #e5e5e5; }
        .quantity-control .qty-display { font-size: 0.8em; font-weight: 600; color: var(--luxury-dark); padding: 0 4px; min-width: 22px; text-align: center; }
        .sweet-card .quantity-input { display: none !important; }

        .sweet-card .btn-add-update { font-weight: 600; border-radius: 10px; padding: 4px 9px; font-size: 0.62em; width: 100%; margin-top: 6px; transition: all var(--transition-speed-fast) ease; text-transform: uppercase; letter-spacing: 0.4px; border: 1px solid transparent; }
        .sweet-card .btn-add { background-color: var(--luxury-brown); color: var(--luxury-light); border-color: var(--luxury-brown); }
        .sweet-card .btn-add:hover { background-color: var(--luxury-dark); border-color: var(--luxury-dark); transform: scale(1.02); }
        .sweet-card .btn-update { background-color: transparent; color: var(--luxury-gold); border: 1px solid var(--luxury-gold); }
        .sweet-card .btn-update:hover { background-color: rgba(218, 165, 32, 0.08); color: var(--luxury-gold); transform: scale(1.02); }
        .sweet-card .btn-add-update.added-pulse { animation: pulseSubtle var(--transition-speed-med) ease-out; }

        /* --- Loading Overlay --- */
        #cardLoadingOverlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.9); z-index: 20; display: flex; align-items: center; justify-content: center; border-radius: 12px; transition: opacity var(--transition-speed-fast) ease, visibility 0s linear var(--transition-speed-fast); opacity: 0; visibility: hidden; }
        #cardLoadingOverlay.visible { opacity: 1; visibility: visible; transition: opacity var(--transition-speed-fast) ease, visibility 0s linear 0s; }
        #cardLoadingOverlay .spinner-border { width: 1.8rem; height: 1.8rem; color: var(--luxury-gold); }

        /* --- Cart Box --- WEB ONLY */
        #cartBox { position: fixed; bottom: 15px; right: 15px; width: 85%; /* Smaller relative width */ max-width: 290px; /* Smaller max width */ max-height: 38vh; /* Smaller max height */ overflow-y: auto; background: linear-gradient(to bottom, #4a4646, var(--luxury-dark)); color: var(--luxury-cream); padding: 12px 15px; /* Reduced padding */ z-index: 1050; box-shadow: var(--shadow-strong); border-radius: 8px; /* Smaller radius */ border: 1px solid var(--luxury-accent); transition: transform var(--transition-speed-med) ease-out, opacity var(--transition-speed-med) ease-out, visibility var(--transition-speed-med) step-end; transform: translateY(15px); opacity: 0; visibility: hidden; }
        #cartBox.cart-visible { transform: translateY(0); opacity: 1; visibility: visible; transition: transform var(--transition-speed-med) ease-out, opacity var(--transition-speed-med) ease-out, visibility var(--transition-speed-med) step-start; }
        #cartBox h3 { font-family: var(--font-heading); text-align: center; margin-top: 0; margin-bottom: 10px; color: var(--luxury-gold); border-bottom: 1px solid rgba(218, 165, 32, 0.2); padding-bottom: 7px; font-size: 1.1em; }
        #cartBox::-webkit-scrollbar { width: 4px; }
        #cartBox::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 2px; }
        #cartBox::-webkit-scrollbar-thumb { background-color: var(--luxury-accent); border-radius: 2px; border: 1px solid transparent; background-clip: content-box; }
        #cartBox::-webkit-scrollbar-thumb:hover { background-color: var(--luxury-gold); }
        .cart-item { display: flex; align-items: center; margin-bottom: 7px; border-bottom: 1px solid rgba(218, 165, 32, 0.1); padding-bottom: 7px; position: relative; animation: slideInRight 0.4s ease-out backwards; }
        .cart-item.removing { animation: shrinkOutFade 0.3s ease-out forwards; }
        .cart-item:nth-child(1) { animation-delay: 0.04s; } .cart-item:nth-child(2) { animation-delay: 0.08s; } .cart-item:nth-child(3) { animation-delay: 0.12s; }
        .cart-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .cart-item img { width: 38px; height: 38px; /* Smaller image */ object-fit: cover; border-radius: 4px; margin-right: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.18); background-color: #eee; flex-shrink: 0; }
        .cart-item-details { flex-grow: 1; margin-right: 4px; }
        .cart-item-details h5 { margin-bottom: 1px; color: var(--luxury-light); font-size: 0.8em; /* Smaller font */ font-weight: 600; }
        .cart-item-details span { font-size: 0.7em; /* Smaller font */ color: var(--luxury-cream); opacity: 0.8; display: block; }
        .remove-item-btn { background: none; border: none; color: var(--luxury-accent); font-size: 1.2em; line-height: 1; cursor: pointer; padding: 0 2px; margin-left: auto; opacity: 0.7; transition: all var(--transition-speed-fast) ease; align-self: center; flex-shrink: 0;}
        .remove-item-btn:hover { color: var(--luxury-gold); opacity: 1; transform: scale(1.1); }
        #emptyCartMsg { padding: 15px 0; color: var(--luxury-cream); opacity: 0.6; text-align: center; font-style: italic; font-size: 0.7em; }

        /* --- Review Step --- */
        #reviewDetails { display: flex; flex-wrap: wrap; gap: 15px; }
        #reviewTextSummary { flex: 1 1 250px; }
        #packagingPreviewContainer { flex: 1 1 270px; padding: 12px; border: 1px solid rgba(0,0,0,0.05); border-radius: 8px; background-color: rgba(255, 255, 255, 0.7); }
        #packagingPreviewContainer h5 { font-family: var(--font-heading); color: var(--luxury-brown); text-align: center; margin-bottom: 12px; font-size: 1.1em; }
        #visualBoxRepresentation { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 8px; padding: 10px; border-radius: 5px; min-height: 150px; align-content: start; transition: background-color var(--transition-speed-med) ease, border var(--transition-speed-med) ease; border: 1.5px solid transparent; }
        #visualBoxRepresentation.visual-box { background-color: #fffcf5; border-color: var(--luxury-brown); }
        #visualBoxRepresentation.visual-tray { background: linear-gradient(135deg, #ecdcc6, #d7c497); border: 1.5px dashed var(--luxury-gold); box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
        .sweet-icon-placeholder { text-align: center; animation: fadeInUp 0.4s ease-out backwards; }
        .sweet-icon-placeholder img { width: 38px; height: 38px; object-fit: cover; border-radius: 50%; border: 1.5px solid var(--luxury-accent); box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 3px; background-color: #eee; }
        .sweet-icon-placeholder span { display: block; font-size: 0.62em; font-weight: 600; color: var(--luxury-dark); line-height: 1.1; }
        #emptyBoxVisualMsg { grid-column: 1 / -1; text-align: center; padding: 15px; color: var(--luxury-brown); font-style: italic; opacity: 0.7; font-size: 0.75em; }
        #reviewTextSummary .list-group-item { background-color: transparent; border-color: rgba(0, 0, 0, 0.04); padding: 5px 0px; color: var(--luxury-dark); font-size: 0.82em; }
        #reviewTextSummary h4 { font-family: var(--font-heading); color: var(--luxury-brown); margin-bottom: 0.8rem; font-size: 1.15em; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 0.3rem; }
        #reviewTextSummary p { margin-top: 0.8rem; font-size: 0.88em; color: var(--luxury-dark); }
        #reviewTextSummary .badge { background-color: var(--luxury-accent); color: var(--luxury-light); font-size: 0.72em; padding: 3px 6px; border-radius: 5px; }
        #reviewTextSummary img { border: 1px solid rgba(0,0,0,0.05); background-color: #eee; }

        /* --- Success Message --- */
        #orderSuccessMessage { display: none; padding: 22px; margin: 18px auto; max-width: 480px; background-color: var(--luxury-light); border-radius: 8px; text-align: center; box-shadow: var(--shadow-medium); border: 1px solid var(--luxury-gold); animation: fadeInUp 0.6s ease-out; }
        #orderSuccessMessage h2 { font-family: var(--font-heading); color: var(--luxury-success); margin-bottom: 9px; font-size: 1.5em; }
        #orderSuccessMessage h2 i { margin-right: 5px; font-size: 0.9em; }
        #orderSuccessMessage p { color: var(--luxury-dark); line-height: 1.45; margin-bottom: 7px; font-size: 0.88em; }
        #orderSuccessMessage #successOrderSummary { font-size: 0.78em; text-align: left; max-width: 330px; margin: 10px auto 15px auto; padding: 10px; border-radius: 4px; background-color: #f9fafa; border: 1px solid #f0f0f0;}
        #orderSuccessMessage #successOrderSummary ul { list-style: none; padding-left: 0; margin-bottom: 5px;}
        #orderSuccessMessage #successOrderSummary li { margin-bottom: 3px; }
        #orderSuccessMessage .btn-new-order { font-family: var(--font-body); font-weight: 600; padding: 8px 20px; border: none; border-radius: 50px; cursor: pointer; transition: all var(--transition-speed-fast) ease; box-shadow: var(--shadow-soft); background: linear-gradient(100deg, var(--luxury-gold), var(--luxury-accent)); color: var(--luxury-light); text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.75em; }
        #orderSuccessMessage .btn-new-order:hover { box-shadow: var(--shadow-medium); transform: translateY(-2px); }
        #orderSuccessMessage .btn-new-order:active { transform: translateY(0px) scale(0.98); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

         /* --- Error Message Styling --- */
        #errorMessage { display: none; padding: 10px; margin: 18px auto; max-width: 550px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 5px; text-align: center; font-size: 0.8em;}
        #errorMessage h4 { color: #721c24; margin-bottom: 5px; font-size: 0.95em; }

        /* --- =========================== --- */
        /* ---    RESPONSIVE ADJUSTMENTS   --- */
        /* --- =========================== --- */

        /* Medium devices (tablets, 768px and up) */
        @media (min-width: 768px) {
            /* Ensure desktop styles apply above mobile breakpoint */
             body { font-size: 14.5px; padding-top: 70px; }
             .main-container { padding-top: 2rem; padding-bottom: 2rem;}
             .main-title { font-size: 2.4em; }
             .navbar .navbar-brand img { max-width: 140px; }
        }

        /* Small devices (landscape phones, less than 768px) - MOBILE STYLES START HERE */
        @media (max-width: 767.98px) {
            body { padding-top: 60px; font-size: 13.5px; } /* Further reduce base font for mobile */
             .main-container { padding-top: 1.5rem; padding-bottom: 1.5rem;}
            .navbar .container { justify-content: space-between; } /* Space out brand and controls */
             .navbar .navbar-brand { margin-right: auto; } /* Push brand left */
             .navbar .navbar-nav { display: none; } /* Hide desktop nav links */
             .navbar-collapse { /* Mobile menu */
                 position: fixed; top: 60px; /* Position below navbar */ right: 0; left: 0;
                 background-color: rgba(40, 36, 36, 0.98); /* Darker */
                 backdrop-filter: blur(6px);
                 padding: 1rem;
                 box-shadow: 0 8px 15px rgba(0,0,0,0.25);
                 border-bottom-left-radius: 8px;
                 border-bottom-right-radius: 8px;
                 z-index: 1040; /* Below navbar but above content */
             }
             .navbar-collapse .navbar-nav { display: block; /* Show links in mobile menu */ }
             .navbar .nav-link { font-size: 0.9em; margin: 0.5rem 0; display: block; text-align: center;} /* Style mobile links */
             .navbar .nav-link::after { display: none; } /* Hide underlines in mobile menu */

             /* Show mobile cart indicator and position it */
             #nav-cart-indicator { display: inline-block; } /* Show it */
             .navbar-controls { display: flex; align-items: center; } /* Group indicator and toggler */

            .main-title { font-size: 1.8em; margin-bottom: 1.2rem; }
            #wizard { max-width: 100%; margin-left: 6px; margin-right: 6px; min-height: auto; }
            #wizard-progress { max-width: 100%; padding: 7px 3px; margin-bottom: 1.5rem;}
            .progress-step { font-size: 0.65em; padding: 4px 2px; font-weight: 500;}
            .progress-step span, .progress-step .step-text { display: none; } /* Hide number and text */
            .progress-step::before { margin-right: 0; font-size: 1.1em; } /* Just show checkmark */
            .progress-step.completed { flex-grow: 0; padding: 4px 8px; } /* Make completed steps smaller */
             .progress-step.active .step-text { display: inline; margin-left: 4px; } /* Show text only for active step */


            .step { border-radius: 10px; max-height: calc(100vh - 120px); /* Limit height relative to viewport */ }
             .step-scrollable-content { padding: 15px 15px; }
             .button-group { padding: 0.7rem 15px; }
            .step h2 { font-size: 1.35em; margin-bottom: 1.2rem; }
            .step button { padding: 8px 18px; font-size: 0.75em; } /* Slightly larger mobile buttons */
            .button-group { flex-direction: column; gap: 8px; align-items: stretch; margin-top: 1.2rem; }
            .button-group .prevStep { order: 2; background-color: #eee; border: 1px solid #ddd; }
            .button-group .nextStep, .button-group #finishOrder, .button-group #confirmOrderBtn { order: 1; width: 100%; }
            #quantityStep .button-group { flex-direction: row; justify-content: flex-end; }

             /* Hide floating cart on mobile */
             #cartBox { display: none !important; }

            .quantity-control { max-width: 95px; } /* Slightly larger touch target */
            .quantity-control .btn-qty { padding: 4px 9px; font-size: 1.1em; }
            .quantity-control .qty-display { font-size: 0.85em; min-width: 24px;}

            #reviewDetails { gap: 12px; } /* Tighter gap */
            #reviewTextSummary h4 { font-size: 1.1em; }
            #packagingPreviewContainer h5 { font-size: 1.0em; }
            #visualBoxRepresentation { gap: 8px; padding: 10px; grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));} /* Slightly larger icons */
            .sweet-icon-placeholder img { width: 40px; height: 40px; margin-bottom: 3px; }
            .sweet-icon-placeholder span { font-size: 0.6em; }

            #orderSuccessMessage { padding: 18px; }
            #orderSuccessMessage h2 { font-size: 1.4em; }
            #orderSuccessMessage p { font-size: 0.85em; }
            #orderSuccessMessage #successOrderSummary { padding: 10px; }
            #orderSuccessMessage .btn-new-order { padding: 9px 22px; font-size: 0.8em; }
        }

        /* Extra small devices (portrait phones, less than 576px) */
        @media (max-width: 575.98px) {
            body { font-size: 13px; padding-top: 55px; }
            .main-container { padding-top: 1.0rem; padding-bottom: 1.0rem;}
            .main-title { font-size: 1.5em; }
            .navbar .navbar-brand img { max-width: 100px; }
            #wizard-progress { display: none; }
            .step h2 { font-size: 1.2em; }
            .sweet-card { max-width: 100%; }
            #sweetCards.row { --bs-gutter-x: 0.5rem; --bs-gutter-y: 0.5rem; }
            .sweet-card .card-body { padding: 7px; }
            .sweet-card .card-title { font-size: 0.9em; }
            .sweet-card .card-text { font-size: 0.68em; line-height: 1.3; max-height: 35px; }
            .sweet-card .btn-add-update { padding: 5px 10px; font-size: 0.65em; } /* Slightly larger button text */
            .quantity-control { max-width: 85px; }
            .quantity-control .btn-qty { padding: 3px 7px; font-size: 1.0em; }
            .quantity-control .qty-display { font-size: 0.8em; min-width: 22px;}
            #reviewTextSummary { min-width: 180px; }
            #visualBoxRepresentation { grid-template-columns: repeat(auto-fill, minmax(42px, 1fr)); gap: 6px; } /* Smaller review icons */
            .button-group { padding: 0.6rem 15px; }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="img/10.png" alt="Darna Logo"
                     onerror="console.error('LOGO LOAD ERROR: Path=\'img/10.png\''); this.onerror=null; this.style.display='none'; const brandText = document.createElement('span'); brandText.textContent='Darna'; brandText.style.color='var(--luxury-gold)'; brandText.style.fontFamily='var(--font-heading)'; brandText.style.fontSize='1.5em'; this.parentNode.appendChild(brandText);">
            </a>

            <!-- Mobile Controls Group -->
            <div class="navbar-controls d-flex align-items-center d-lg-none">
                 <!-- Mobile Cart Indicator (Initially Hidden) -->
                 <a href="#" id="nav-cart-indicator" class="nav-link" aria-label="View Selections">
                    <i class="bi bi-box-seam"></i>
                    <span class="badge">0</span>
                 </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>

            <!-- Desktop Nav Links & Mobile Menu Content -->
             <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                 <ul class="navbar-nav">
                     <li class="nav-item"><a class="nav-link" href="#">Home</a></li>
                     <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">Custom Box</a></li>
                     <li class="nav-item"><a class="nav-link" href="#initiatives">Initiatives</a></li>
                     <li class="nav-item"><a class="nav-link" href="#contact">Contact</a></li>
                 </ul>
             </div>
        </div>
    </nav>

    <!-- Main Content -->
    <section class="container main-container">
        <h1 class="main-title">Compose Your Exquisite Sweet Box</h1>

        <!-- Error Message Placeholder -->
        <div id="errorMessage">
            <h4>Oops! Something went wrong.</h4>
            <p>We couldn't load the delicacy data. Please ensure the 'sweets.json' file exists and is accessible, then refresh the page.</p>
            <p><small>Error details logged to the console.</small></p>
        </div>

        <!-- Wizard Area -->
        <div id="wizardContainer">
            <div id="wizard-progress">
                <div class="progress-step" data-step="0"><span>1.</span><span class="step-text"> Preference</span></div>
                <div class="progress-step" data-step="1"><span>2.</span><span class="step-text"> Delicacies</span></div>
                <div class="progress-step" data-step="2"><span>3.</span><span class="step-text"> Presentation</span></div>
                <div class="progress-step" data-step="3"><span>4.</span><span class="step-text"> Review</span></div>
            </div>
            <div id="wizard">
                <!-- Step 1: Quantity Type -->
                <div id="quantityStep" class="step">
                    <div class="step-scrollable-content">
                         <h2>Choose Your Preference</h2>
                         <div class="form-check"><input class="form-check-input" type="radio" name="quantityType" id="quantityUnit" value="unit" checked><label class="form-check-label" for="quantityUnit">Order by Unit</label></div>
                         <div class="form-check"><input class="form-check-input" type="radio" name="quantityType" id="quantityWeight" value="weight"><label class="form-check-label" for="quantityWeight">Order by Weight</label></div>
                    </div>
                     <div class="button-group">
                        <button type="button" class="btn btn-secondary prevStep" style="visibility: hidden;">Back</button>
                        <button type="button" class="btn btn-primary nextStep">Next: Delicacies</button>
                    </div>
                </div>

                <!-- Step 2: Sweet Selection -->
                <div id="sweetSelectionStep" class="step">
                    <div class="step-scrollable-content">
                        <h2>Select Your Delicacies</h2>
                        <div id="cardLoadingOverlay"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>
                        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-2 g-md-3 justify-content-center" id="sweetCards"> {/* Reduced gutters */}
                            <p class="text-muted text-center col-12">Loading delicacies...</p>
                        </div>
                    </div>
                     <div class="button-group">
                         <button type="button" class="btn btn-secondary prevStep">Back: Preference</button>
                         <button type="button" class="btn btn-primary nextStep">Next: Presentation</button>
                     </div>
                </div>

                <!-- Step 3: Packaging -->
                <div id="packagingStep" class="step">
                     <div class="step-scrollable-content">
                         <h2>Choose Presentation</h2>
                         <div class="form-check"><input class="form-check-input" type="radio" name="packaging" id="box" value="box" checked><label class="form-check-label" for="box">Signature Darna Box</label></div>
                         <div class="form-check"><input class="form-check-input" type="radio" name="packaging" id="tray" value="tray"><label class="form-check-label" for="tray">Ornate Keepsake Tray (+$8.00)</label></div>
                     </div>
                     <div class="button-group">
                        <button type="button" class="btn btn-secondary prevStep">Back: Delicacies</button>
                        <button type="button" class="btn btn-primary" id="finishOrder">Next: Review</button>
                    </div>
                </div>

                 <!-- Step 4: Review -->
                 <div id="reviewStep" class="step">
                    <div class="step-scrollable-content">
                        <h2>Review Your Creation</h2>
                        <div id="reviewDetails">
                            <div id="reviewTextSummary"></div>
                            <div id="packagingPreviewContainer">
                                 <h5>Visual Preview</h5>
                                 <div id="visualBoxRepresentation"></div>
                            </div>
                        </div>
                         <div class="alert alert-light border-warning mt-3 small py-2" style="background-color: #fffaf0;">
                            <i class="bi bi-info-circle-fill text-warning me-1"></i>Review selections. This is a demo.
                        </div>
                    </div>
                     <div class="button-group">
                         <button type="button" class="btn btn-secondary prevStep">Back: Presentation</button>
                         <button type="button" class="btn btn-success" id="confirmOrderBtn"><i class="bi bi-check-lg me-1"></i>Confirm</button>
                     </div>
                </div>
            </div>
        </div>

        <!-- Order Success Message -->
         <div id="orderSuccessMessage">
              <h2><i class="bi bi-patch-check-fill"></i> Order Confirmed!</h2>
              <p>Your exquisite selection is noted. Thank you!</p>
              <div id="successOrderSummary"></div>
              <button id="startNewOrderBtn" class="btn-new-order mt-3">Compose Another</button>
         </div>
    </section>

    <!-- Cart Box (Hidden on Mobile via CSS) -->
    <div id="cartBox">
        <h3>Your Bespoke Box</h3>
        <div id="cartItems">
            <p id="emptyCartMsg">Your box awaits selections.</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Wrap entire script in a try...catch
        try {
            $(document).ready(function() {
                console.log("Document ready. Initializing Darna Wizard (v11 - Mobile Cart Indicator)...");

                // --- Global State Variables ---
                let cart = [];
                let currentStep = 0;
                let sweets = [];
                let chosenQuantityType = 'unit';
                let chosenPackaging = 'box';
                const packagingCost = { box: 0, tray: 8.00 };

                // --- DOM Element References ---
                const steps = $(".step");
                const progressSteps = $(".progress-step");
                const wizardContainer = $("#wizardContainer");
                const successMessageContainer = $("#orderSuccessMessage");
                const cardLoadingOverlay = $("#cardLoadingOverlay");
                const cartBox = $("#cartBox"); // Desktop floating cart
                const cartItemsContainer = $("#cartItems");
                const emptyCartMsg = $("#emptyCartMsg");
                const sweetCardsContainer = $("#sweetCards");
                const errorMessageContainer = $("#errorMessage");
                const navCartIndicator = $("#nav-cart-indicator"); // Mobile navbar indicator
                const navCartBadge = navCartIndicator.find(".badge"); // Mobile badge

                // --- Utility ---
                const placeholderImg = 'img/placeholder.png';
                function getSweetById(id) {
                    if (!sweets || sweets.length === 0) return null;
                    return sweets.find(s => s.id === id);
                }
                function formatQuantity(quantity, type) { return type === 'unit' ? `${quantity} pc${quantity !== 1 ? 's' : ''}` : `${quantity}g`; }

                 // --- Mobile Navbar Cart Indicator Update ---
                 function updateNavbarCartIndicator() {
                    const itemCount = cart.reduce((sum, item) => sum + (item.quantityType === 'unit' ? item.quantity : 1), 0); // Count units or 1 per weight item
                    // console.log("DEBUG: Updating navbar indicator. Count:", itemCount); // Can be noisy
                    if (itemCount > 0) {
                        navCartBadge.text(itemCount).show();
                        navCartIndicator.show(); // Ensure icon is visible if badge has count
                    } else {
                        navCartBadge.hide();
                        // Optional: Hide icon completely if cart is empty
                        // navCartIndicator.hide();
                    }
                }

                // --- Cart Display & Visibility (Handles Desktop Cart AND Mobile Indicator) ---
                function showCart() { // Only affects desktop cart visibility
                    if (!cartBox.hasClass('cart-visible')) {
                         cartBox.addClass('cart-visible');
                         console.log("DEBUG: Desktop Cart shown.");
                    }
                }
                function hideCart() { // Only affects desktop cart visibility
                    if (cartBox.hasClass('cart-visible')) {
                        cartBox.removeClass('cart-visible');
                        console.log("DEBUG: Desktop Cart hidden.");
                    }
                }
                 function updateCartDisplay() { // Updates both desktop cart items and mobile indicator
                    cartItemsContainer.empty(); // Clear desktop cart items
                    if (cart.length === 0) {
                        cartItemsContainer.append(emptyCartMsg);
                        hideCart(); // Hide desktop cart
                    } else {
                        cart.forEach((item, index) => {
                            const delay = index * 0.05;
                            const itemImagePath = item.img || placeholderImg;
                            cartItemsContainer.append(`<div class="cart-item" style="animation-delay: ${delay}s;"><img src="${itemImagePath}" alt="${item.name}" onerror="this.onerror=null; this.src='${placeholderImg}'; this.alt='Img missing'; console.error('Cart Img Error: ${itemImagePath}')"><div class="cart-item-details"><h5>${item.name}</h5><span>${formatQuantity(item.quantity, item.quantityType)}</span></div><button class="remove-item-btn" data-sweet-id="${item.sweetId}" aria-label="Remove ${item.name}">×</button></div>`);
                        });
                        // Show desktop cart only if on step 2
                        if (currentStep === 1) { showCart(); } else { hideCart();}
                    }
                    updateNavbarCartIndicator(); // Update mobile indicator regardless of step
                }


                // --- Wizard Navigation & Animation ---
                function updateWizardProgress(targetStepIndex) {
                    progressSteps.each(function(index) {
                        const $step = $(this);
                        $step.removeClass('active completed');
                        if (index < targetStepIndex) { $step.addClass('completed'); }
                        else if (index === targetStepIndex) { $step.addClass('active'); }
                    });
                }

                function showStep(stepIndex) {
                    console.log(`DEBUG: showStep called for index: ${stepIndex}`);
                    if (stepIndex < 0 || stepIndex >= steps.length) { console.error(`ERROR: Invalid step index requested: ${stepIndex}`); return; }
                    const $currentStep = $(steps[currentStep]);
                    const $nextStep = $(steps[stepIndex]);
                    if (stepIndex !== currentStep) { $currentStep.addClass('exiting-step'); }

                    setTimeout(() => {
                        try {
                            steps.removeClass('active-step exiting-step');
                            $nextStep.addClass('active-step');
                            const previousStep = currentStep;
                            currentStep = stepIndex;
                            console.log(`DEBUG: currentStep is now ${currentStep}`);
                            updateWizardProgress(currentStep);

                            // Cart Visibility (Desktop only)
                            if (currentStep === 1) { if (cart.length > 0) showCart(); else hideCart(); }
                            else { hideCart(); }

                            // Content Generation
                            if (currentStep === 1) {
                                console.log("DEBUG: Generating content for Step 2 (Delicacies)");
                                if (sweets && sweets.length > 0) {
                                    if (previousStep !== 1 || sweetCardsContainer.children().length <= 1) {
                                        showLoadingOverlay(); updateQuantityLabelsAndInputs();
                                        setTimeout(() => {
                                            try { generateSweetCards(); }
                                            catch (e) { console.error("ERROR generating cards:", e); sweetCardsContainer.html('<p class="text-danger text-center col-12">Error generating delicacies display.</p>'); }
                                            finally { hideLoadingOverlay(); }
                                        }, 50);
                                    } else { updateQuantityLabelsAndInputs(); }
                                } else {
                                    console.warn("DEBUG: Sweet data not available when trying to show step 2."); sweetCardsContainer.html('<p class="text-warning text-center col-12">Delicacy data loading or failed.</p>');
                                }
                            } else if (currentStep === 3) {
                                console.log("DEBUG: Generating content for Step 4 (Review)");
                                try { populateReview(); }
                                catch (e) { console.error("ERROR populating review:", e); $("#reviewDetails").html('<p class="text-danger text-center col-12">Could not generate review.</p>'); }
                            }
                            console.log(`DEBUG: Successfully displayed step ${currentStep}`);
                         } catch (e) {
                              console.error(`ERROR inside showStep timeout for step ${stepIndex}:`, e);
                         }
                    }, stepIndex === currentStep ? 0 : 350);
                 }

                function showLoadingOverlay() { cardLoadingOverlay.addClass('visible'); }
                function hideLoadingOverlay() { cardLoadingOverlay.removeClass('visible'); }

                function updateQuantityLabelsAndInputs(container = sweetCardsContainer) {
                    const quantityLabelText = chosenQuantityType === 'unit' ? 'Units:' : 'Grams:';
                    const minQuantity = chosenQuantityType === 'unit' ? 1 : 50;
                    const stepQuantity = chosenQuantityType === 'unit' ? 1 : 10;

                    container.find(".quantity-control-wrapper label.visually-hidden").text(quantityLabelText);
                    container.find(".quantity-input").each(function() {
                         const $input = $(this);
                         $input.attr('min', minQuantity).attr('step', stepQuantity);
                         const currentVal = parseInt($input.val(), 10);
                         if (!isNaN(currentVal) && currentVal < minQuantity) {
                              $input.val(minQuantity);
                              $input.closest('.quantity-control-wrapper').find('.qty-display').text(minQuantity);
                         }
                    });
                }

                // --- Sweet Card Generation ---
                function generateSweetCards() {
                    sweetCardsContainer.empty();
                    if (!sweets || sweets.length === 0) { console.error("ERROR: generateSweetCards - No sweets data available."); sweetCardsContainer.append('<p class="text-center text-danger col-12">No delicacies data found.</p>'); return; }
                    const quantityLabelText = chosenQuantityType === 'unit' ? 'Units:' : 'Grams:';
                    const minQuantity = chosenQuantityType === 'unit' ? 1 : 50;
                    const stepQuantity = chosenQuantityType === 'unit' ? 1 : 10;

                    sweets.forEach((sweet, index) => {
                        const existingCartItem = cart.find(item => item.sweetId === sweet.id);
                        const isInCart = !!existingCartItem;
                        const currentQuantity = isInCart ? existingCartItem.quantity : minQuantity;
                        const buttonText = isInCart ? 'Update In Cart' : 'Add To Box';
                        const buttonClass = isInCart ? 'btn-update' : 'btn-add';
                        const cardClass = isInCart ? 'card-in-cart' : '';
                        const imagePath = sweet.img || placeholderImg;
                        let variationsHtml = '';
                        if (sweet.variations && sweet.variations.length > 0) {
                            variationsHtml = `<div class="sweet-variations">`;
                            sweet.variations.slice(0, 1).forEach(v => { variationsHtml += `<i class="bi bi-dot"></i> ${v}`; });
                             if (sweet.variations.length > 1) variationsHtml += ` (+)`;
                            variationsHtml += `</div>`;
                        }
                        sweetCardsContainer.append(`
                            <div class="sweet-card-column d-flex align-items-stretch">
                                <div class="card sweet-card ${cardClass}" style="animation-delay: ${index * 0.04}s;" data-sweet-id="${sweet.id}">
                                    <img src="${imagePath}" class="card-img-top selectable-card-img" alt="${sweet.name}" onerror="this.onerror=null; this.src='${placeholderImg}'; this.alt='Img missing'; console.error('IMAGE LOAD ERROR: Path=\\'${imagePath}\\' for ${sweet.name}');">
                                    <div class="card-body">
                                        <h5 class="card-title">${sweet.name}</h5>
                                        ${variationsHtml}
                                        <p class="card-text">${sweet.description}</p>
                                        <div class="form-group mt-auto">
                                            <div class="quantity-control-wrapper mb-2">
                                                 <label for="quantity_${sweet.id}" class="visually-hidden">${quantityLabelText}</label>
                                                 <div class="quantity-control">
                                                      <button type="button" class="btn-qty btn-qty-decrease" data-action="decrease" aria-label="Decrease quantity for ${sweet.name}">-</button>
                                                      <span class="qty-display" aria-live="polite">${currentQuantity}</span>
                                                      <button type="button" class="btn-qty btn-qty-increase" data-action="increase" aria-label="Increase quantity for ${sweet.name}">+</button>
                                                 </div>
                                                 <input type="number" class="quantity-input" id="quantity_${sweet.id}" value="${currentQuantity}" min="${minQuantity}" step="${stepQuantity}" data-sweet-id="${sweet.id}" aria-label="Qty ${sweet.name}">
                                             </div>
                                             <button class="btn btn-sm btn-add-update ${buttonClass}" data-sweet-id="${sweet.id}" data-sweet-name="${sweet.name}" data-img="${imagePath}">${buttonText}</button>
                                         </div>
                                    </div>
                                </div>
                            </div>`);
                    });
                    updateQuantityLabelsAndInputs();
                    console.log("DEBUG: Sweet cards generated.");
                 }

                function updateCardState(sweetId) { // Updates card border and Add/Update button text
                    const card = sweetCardsContainer.find(`.sweet-card[data-sweet-id="${sweetId}"]`);
                    if (!card.length) return;
                    const existingCartItem = cart.find(item => item.sweetId === sweetId);
                    const isInCart = !!existingCartItem;
                    const button = card.find('.btn-add-update');
                    const minQuantity = chosenQuantityType === 'unit' ? 1 : 50;
                    const quantityInput = card.find('.quantity-input');
                    const quantityDisplay = card.find('.qty-display');

                    if (isInCart) {
                        card.addClass('card-in-cart'); button.removeClass('btn-add').addClass('btn-update').text('Update In Cart');
                        quantityInput.val(existingCartItem.quantity); quantityDisplay.text(existingCartItem.quantity);
                    } else {
                        card.removeClass('card-in-cart'); button.removeClass('btn-update').addClass('btn-add').text('Add To Box');
                        quantityInput.val(minQuantity); quantityDisplay.text(minQuantity);
                    }
                 }
                 function updateAllCardStates() { sweetCardsContainer.find(".sweet-card").each(function() { updateCardState($(this).data('sweet-id')); }); }

                // --- Step Navigation Buttons --- (With Debugging)
                $(".nextStep").click(function() {
                    console.log(`DEBUG: Next button clicked. Current step: ${currentStep}`);
                    let canProceed = true;
                    try {
                        if (currentStep === 0) {
                            const newQuantityType = $('input[name="quantityType"]:checked').val();
                            console.log(`DEBUG: Step 0 Check. Current Type: ${chosenQuantityType}, New Type: ${newQuantityType}, Cart Length: ${cart.length}`);
                            if (newQuantityType !== chosenQuantityType && cart.length > 0) {
                                console.log("DEBUG: Type changed with items in cart, showing confirmation.");
                                if (confirm("Changing preference type will clear selections. Proceed?")) {
                                    console.log("DEBUG: User confirmed type change. Clearing cart.");
                                    cart = []; updateCartDisplay(); chosenQuantityType = newQuantityType;
                                } else {
                                    console.log("DEBUG: User cancelled type change.");
                                    $(`input[name="quantityType"][value="${chosenQuantityType}"]`).prop('checked', true);
                                    canProceed = false;
                                }
                            } else {
                                if (newQuantityType !== chosenQuantityType) {
                                    console.log("DEBUG: Updating quantity type without clearing cart.");
                                    chosenQuantityType = newQuantityType;
                                    updateQuantityLabelsAndInputs();
                                }
                            }
                        } else if (currentStep === 1) {
                            console.log(`DEBUG: Step 1 Check. Cart Length: ${cart.length}`);
                            if (cart.length === 0) {
                                alert("Your box is empty! Please select some delicacies.");
                                console.log("DEBUG: Proceed blocked on Step 1 (cart empty).");
                                canProceed = false;
                            }
                        }

                        console.log(`DEBUG: Checking conditions to proceed. canProceed: ${canProceed}, currentStep: ${currentStep}, steps.length-1: ${steps.length - 1}`);
                        if (canProceed && currentStep < steps.length - 1) {
                            console.log(`DEBUG: Conditions met. Calling showStep(${currentStep + 1})`);
                            showStep(currentStep + 1);
                        } else {
                             console.log("DEBUG: Conditions not met or already on last step. Not proceeding.");
                        }

                    } catch(e) {
                         console.error("ERROR in nextStep click handler:", e);
                         alert("An error occurred while trying to proceed. Please check the console.");
                         canProceed = false;
                    }
                });

                $(".prevStep").click(function() {
                     console.log(`DEBUG: Prev button clicked. Current step: ${currentStep}`);
                     if (currentStep > 0) { showStep(currentStep - 1); }
                 });
                $(document).on('click', '#wizard-progress .progress-step.completed', function() {
                    const targetStep = parseInt($(this).data('step'), 10);
                    console.log(`DEBUG: Completed progress step clicked for step: ${targetStep}`);
                    if (!isNaN(targetStep) && targetStep < currentStep) { showStep(targetStep); }
                 });

                // --- Click Handler for Card Image ---
                $(document).on('click', '.selectable-card-img', function(event) {
                     console.log("DEBUG: Card image clicked.");
                     $(this).closest('.sweet-card').find('.btn-add-update').trigger('click');
                 });

                // --- Event Listener for Quantity Buttons (+/-) ---
                sweetCardsContainer.on('click', '.btn-qty', function() {
                    const $button = $(this); const action = $button.data('action');
                    const $formGroup = $button.closest('.form-group'); const $input = $formGroup.find('.quantity-input');
                    const $display = $formGroup.find('.qty-display'); const $addUpdateButton = $formGroup.find('.btn-add-update');
                    const currentVal = parseInt($input.val(), 10); const min = parseInt($input.attr('min'), 10); const step = parseInt($input.attr('step'), 10);
                    let newVal = currentVal;
                    if (isNaN(currentVal) || isNaN(min) || isNaN(step)) { console.error("ERROR: Invalid quantity values in +/- handler."); return; }
                    if (action === 'increase') { newVal += step; } else if (action === 'decrease') { newVal -= step; }
                    newVal = Math.max(min, newVal);
                    $input.val(newVal); $display.text(newVal);
                    $addUpdateButton.trigger('click');
                });

                // --- Add/Update To Cart (Triggered by +/- or button click) ---
                $(document).on("click", ".btn-add-update", function(event) {
                    const isUserClick = event.originalEvent !== undefined;
                    const $button = $(this); const sweetId = $button.data('sweet-id');
                    console.log(`DEBUG: Add/Update logic triggered for ${sweetId}. User click: ${isUserClick}`);
                    const sweetName = $button.data('sweet-name'); const sweetImg = $button.data('img') || placeholderImg;
                    const quantityInput = $button.closest('.form-group').find('.quantity-input');
                    let quantity = parseInt(quantityInput.val(), 10);
                    const minQuantity = parseInt(quantityInput.attr('min'), 10);

                    if (isNaN(quantity) || quantity < minQuantity) { console.warn(`WARN: Correcting quantity for ${sweetId} to min ${minQuantity}`); quantity = minQuantity; quantityInput.val(quantity); $button.closest('.form-group').find('.qty-display').text(quantity); }

                    const existingCartItemIndex = cart.findIndex(item => item.sweetId === sweetId);
                    let itemUpdated = false;

                    if (existingCartItemIndex > -1) {
                        if (cart[existingCartItemIndex].quantity !== quantity) {
                            cart[existingCartItemIndex].quantity = quantity; cart[existingCartItemIndex].quantityType = chosenQuantityType;
                            console.log(`DEBUG: Updated ${sweetName} to ${quantity}`); itemUpdated = true;
                        }
                    } else {
                        cart.push({ sweetId: sweetId, name: sweetName, quantity: quantity, quantityType: chosenQuantityType, img: sweetImg });
                        console.log(`DEBUG: Added ${sweetName} with ${quantity}`); itemUpdated = true;
                    }

                    if(itemUpdated) { $button.addClass('added-pulse'); setTimeout(() => $button.removeClass('added-pulse'), 400); updateCartDisplay(); }
                    updateCardState(sweetId);
                });

                // --- Remove From Cart ---
                $(document).on('click', '.remove-item-btn', function() {
                    const $button = $(this); const sweetIdToRemove = $button.data('sweet-id'); const cartItemElement = $button.closest('.cart-item');
                    console.log(`DEBUG: Remove button clicked for ${sweetIdToRemove}`);
                    cartItemElement.addClass('removing');
                    setTimeout(() => {
                        cart = cart.filter(item => item.sweetId !== sweetIdToRemove);
                        updateCartDisplay(); // Handles hiding cart & updating indicator
                        updateCardState(sweetIdToRemove); // Update the corresponding card
                        console.log(`DEBUG: Removed ${sweetIdToRemove}`);
                    }, 350);
                });

                // --- Go To Review Step Button ---
                $("#finishOrder").click(function() { chosenPackaging = $('input[name="packaging"]:checked').val(); console.log(`DEBUG: Finish Order clicked. Packaging: ${chosenPackaging}`); if (chosenPackaging) { showStep(3); } else { alert("Please select a presentation option."); } });

                // --- Populate Review Step ---
                function populateReview() {
                     console.log("DEBUG: Populating review step.");
                    const reviewTextSummary = $("#reviewTextSummary"); const visualBox = $("#visualBoxRepresentation"); reviewTextSummary.empty(); visualBox.empty();
                    let summaryHtml = `<h4>Selections:</h4><ul class="list-group list-group-flush mb-3">`;
                    if (cart.length > 0) { cart.forEach(item => { summaryHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">${item.name}<span class="badge rounded-pill">${formatQuantity(item.quantity, item.quantityType)}</span></li>`; }); } else { summaryHtml += `<li class="list-group-item">No delicacies selected yet.</li>`; }
                    summaryHtml += `</ul><h4>Presentation:</h4><ul class="list-group list-group-flush">`;
                    const packagingName = chosenPackaging === 'box' ? 'Signature Darna Box' : 'Ornate Keepsake Tray'; summaryHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">Style<span>${packagingName}</span></li>`;
                    const cost = packagingCost[chosenPackaging]; if (cost > 0) { summaryHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">Additional Cost<span>+$${cost.toFixed(2)}</span></li>`; }
                    summaryHtml += `</ul><p class="mt-3 fst-italic text-muted small">Note: Pricing shown is indicative for this demo.</p>`; reviewTextSummary.html(summaryHtml);
                    visualBox.removeClass('visual-box visual-tray').addClass(chosenPackaging === 'box' ? 'visual-box' : 'visual-tray');
                    if (cart.length > 0) { let iconCounter = 0; cart.forEach(item => { let iconsToShow = 1; if (item.quantityType === 'unit') { iconsToShow = Math.min(item.quantity, 8); } for (let i = 0; i < iconsToShow; i++) { const delay = iconCounter * 0.04; const itemImagePath = item.img || placeholderImg; const iconLabel = (iconsToShow > 1 && i > 0) ? item.name : `${item.name} (${formatQuantity(item.quantity, item.quantityType)})`; visualBox.append(`<div class="sweet-icon-placeholder" style="animation-delay: ${delay}s;"><img src="${itemImagePath}" alt="${item.name}" onerror="this.onerror=null; this.src='${placeholderImg}'; this.alt='Img missing'; console.error('Review Img Error: ${itemImagePath}')"><span>${iconLabel}</span></div>`); iconCounter++; } }); }
                    else { visualBox.html('<p id="emptyBoxVisualMsg" class="col-12">Your presentation awaits your selections!</p>'); }
                 }

                // --- Confirm Order ---
                $("#confirmOrderBtn").click(function() {
                    console.log("DEBUG: Confirm Order clicked."); const $button = $(this); if ($button.prop('disabled')) { return; }
                    $button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Confirming...');
                    setTimeout(() => {
                        console.log("DEBUG: Simulating order confirmation..."); const successSummary = $("#successOrderSummary"); successSummary.empty(); let successHtml = `<p><strong>Your Order Summary:</strong></p><ul>`;
                        if (cart.length > 0) { cart.forEach(item => { successHtml += `<li>${item.name}: ${formatQuantity(item.quantity, item.quantityType)}</li>`; }); } else { successHtml += `<li>No items were selected.</li>`; } successHtml += `</ul>`;
                        const packagingName = chosenPackaging === 'box' ? 'Signature Darna Box' : 'Ornate Keepsake Tray'; successHtml += `<p><strong>Presentation:</strong> ${packagingName}</p>`; const orderId = Math.floor(10000 + Math.random() * 90000); successHtml += `<p><strong>Order ID:</strong> #${orderId}</p>`; successSummary.html(successHtml);
                        wizardContainer.fadeOut(300, function() { successMessageContainer.fadeIn(500); $('html, body').animate({ scrollTop: successMessageContainer.offset().top - 100 }, 500); }); hideCart();
                        $button.prop('disabled', false).html('<i class="bi bi-check-lg me-1"></i>Confirm'); console.log("DEBUG: Order confirmation display complete.");
                    }, 1000);
                });

                // --- Start New Order ---
                $("#startNewOrderBtn").click(function() {
                    console.log("DEBUG: Start New Order clicked."); cart = []; currentStep = 0; chosenQuantityType = 'unit'; chosenPackaging = 'box';
                    $('input[name="quantityType"][value="unit"]').prop('checked', true); $('input[name="packaging"][value="box"]').prop('checked', true); updateCartDisplay(); hideCart();
                    successMessageContainer.fadeOut(300, function() { showStep(0); wizardContainer.fadeIn(500); updateAllCardStates(); $('html, body').animate({ scrollTop: 0 }, 500); console.log("DEBUG: State reset for new order."); });
                });

                // --- LOAD DATA & INITIALIZE ---
                function initializeApp() {
                    console.log("DEBUG: Initializing application...");
                    errorMessageContainer.hide(); wizardContainer.show(); successMessageContainer.hide(); hideLoadingOverlay();
                    updateNavbarCartIndicator(); // Initial indicator update
                    showStep(0); // Start at step 0
                    updateCartDisplay(); // Update desktop cart (will be hidden)
                    console.log("DEBUG: Initialization complete.");
                }

                console.log("DEBUG: Attempting to fetch sweets.json...");
                fetch('sweets.json')
                    .then(response => {
                        console.log(`DEBUG: Fetch response status: ${response.status}`);
                        if (!response.ok) { throw new Error(`HTTP error! status: ${response.status} - Could not fetch sweets.json`); }
                        return response.json();
                    })
                    .then(data => {
                         console.log("DEBUG: sweets.json loaded and parsed successfully.");
                        if(!Array.isArray(data)){ throw new Error("sweets.json did not contain a valid JSON array."); } // Add check
                        sweets = data;
                        initializeApp();
                    })
                    .catch(error => {
                        console.error("ERROR loading or parsing sweet data:", error);
                        errorMessageContainer.find('p').first().text(error.message || "We couldn't load the delicacy data. Please ensure 'sweets.json' exists, is valid JSON, and is accessible, then refresh the page.");
                        errorMessageContainer.show();
                        wizardContainer.hide();
                    });

            }); // End document ready
        } catch (error) { // --- Fallback Error Handling ---
             console.error("CRITICAL ERROR during script initialization:", error);
             const errorDiv = document.createElement('div'); errorDiv.style.position = 'fixed'; errorDiv.style.top = '0'; errorDiv.style.left = '0'; errorDiv.style.width = '100%'; errorDiv.style.padding = '10px'; errorDiv.style.backgroundColor = '#dc3545'; errorDiv.style.color = 'white'; errorDiv.style.textAlign = 'center'; errorDiv.style.zIndex = '9999'; errorDiv.style.fontSize = '0.9em'; errorDiv.textContent = 'Oops! A critical problem occurred setting up the page. Check console (F12) & Refresh.'; document.body.prepend(errorDiv);
        }
    </script>

</body>
</html>