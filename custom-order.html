<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darna - Exquisite Custom Sweet Boxes</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Clicker+Script&display=swap" rel="stylesheet"> <!-- Added Clicker Script for brand fallback -->
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Custom Styles -->
    <style>
        :root {
            --brand-gold: #9C7945;
            --brand-cream: #FFF5EE;
            --brand-dark-brown: #8B4513;
            --brand-crimson: crimson;
            --brand-dark-bg: #343a40;
            --brand-light-text: #f8f9fa;
            --luxury-dark: var(--brand-dark-bg);
            --luxury-brown: var(--brand-dark-brown);
            --luxury-gold: var(--brand-gold);
            --luxury-cream: var(--brand-cream);
            --luxury-light: #FFFFFF;
            --luxury-accent: #B08D57;
            --luxury-success: #5a7d3c;
            --font-heading: 'Playfair Display', serif;
            --font-body: 'Lato', sans-serif;
            --transition-speed-fast: 0.25s;
            --transition-speed-med: 0.4s;
            --transition-speed-slow: 0.6s;
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.06);
            --shadow-medium: 0 6px 16px rgba(0, 0, 0, 0.08);
            --shadow-strong: 0 8px 24px rgba(0, 0, 0, 0.10);
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shrinkOutFade { from { transform: scale(1); opacity: 1; } to { transform: scale(0.95); opacity: 0; } }
        @keyframes cartItemSlideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes cartItemShrinkOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); } }

        html { scroll-behavior: smooth; }
        body {
            background: linear-gradient(180deg, var(--luxury-cream) 0%, #f7f3eb 100%);
            font-family: var(--font-body); color: var(--brand-dark-brown); margin: 0;
            padding-top: 70px; font-size: 14px; animation: fadeIn var(--transition-speed-slow) ease-out;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            display: flex; flex-direction: column; min-height: 100vh;
        }
        .navbar {
            background-color: var(--brand-dark-bg) !important; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.18);
            padding: 0.6rem 1rem; min-height: 70px;
        }
        .navbar .navbar-brand img { max-width: 130px; height: auto; transition: transform var(--transition-speed-fast) ease; }
        .navbar .navbar-brand:hover img { transform: scale(1.04); }
        .navbar .nav-link {
            color: var(--brand-light-text) !important; font-weight: 500; text-transform: uppercase;
            letter-spacing: 0.5px; font-size: 0.9em; margin: 0 0.5rem;
            transition: color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
            position: relative; padding-bottom: 3px;
        }
        .navbar .nav-link::after {
            content: ''; position: absolute; bottom: 0px; left: 50%; transform: translateX(-50%);
            width: 0; height: 1.5px; background-color: var(--brand-gold);
            transition: width var(--transition-speed-fast) ease;
        }
        .navbar .nav-link:hover::after, .navbar .nav-link.active::after { width: 45%; }
        .navbar .nav-link:hover, .navbar .nav-link.active { color: var(--brand-gold) !important; transform: translateY(-1px); }
        .navbar-toggler { padding: .25rem .5rem; border-color: rgba(255,255,255,0.3); }
        .navbar-toggler-icon {
            width: 1.2em; height: 1.2em;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28248, 249, 250, 0.8%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        #nav-cart-indicator {
             display: none; color: var(--brand-light-text); font-size: 1.4em;
             position: relative; margin-right: 0.75rem; cursor: pointer;
             transition: color var(--transition-speed-fast) ease;
         }
        #nav-cart-indicator:hover { color: var(--brand-gold); }
        #nav-cart-indicator .badge {
             position: absolute; top: -5px; right: -10px; font-size: 0.6em;
             padding: 2px 4px; line-height: 1; background-color: var(--brand-gold);
             color: var(--brand-dark-bg); border-radius: 50%;
             transition: transform var(--transition-speed-fast) ease;
        }
        #nav-cart-indicator:hover .badge { transform: scale(1.1); }
        .navbar-brand-text-fallback {
            color: var(--brand-gold); font-family: 'Clicker Script', cursive;
            font-size: 1.8em; font-weight: bold; display: inline-block;
            line-height: 1; padding: 5px 0;
        }
        .main-container { padding: 1.8rem 1rem; flex-grow: 1; }
        .main-title { font-family: var(--font-heading); font-style: italic; color: var(--luxury-brown); font-size: 2.2em; text-align: center; margin-bottom: 1.5rem; animation: fadeInUp 1s ease-out 0.2s backwards; }
        #wizard-progress { display: flex; justify-content: space-around; margin-bottom: 1.8rem; padding: 9px 5px; background-color: rgba(255, 255, 255, 0.85); border-radius: 50px; box-shadow: var(--shadow-soft); max-width: 600px; margin-left: auto; margin-right: auto; animation: fadeInUp 1s ease-out 0.4s backwards; }
        .progress-step { text-align: center; color: var(--luxury-brown); opacity: 0.6; font-weight: 600; font-size: 0.7em; flex: 1; padding: 5px 2px; border-bottom: 2px solid transparent; transition: all var(--transition-speed-med) ease-out; cursor: default; position: relative; line-height: 1.2; }
        .progress-step.active { color: var(--luxury-gold); opacity: 1; border-bottom-color: var(--luxury-gold); transform: scale(1.03); }
        .progress-step.completed { color: var(--luxury-accent); opacity: 1; cursor: pointer; }
        .progress-step.completed::before { content: 'âœ“'; margin-right: 2px; color: var(--luxury-accent); display: inline-block; }
        #wizard { max-width: 700px; margin: 15px auto 30px auto; position: relative; overflow: visible; min-height: 380px; }
        .step {
            position: absolute; top: 0; left: 0; width: 100%; opacity: 0; visibility: hidden;
            display: flex; flex-direction: column; height: 100%; max-height: 70vh;
            border: 1px solid rgba(0, 0, 0, 0.04); border-radius: 12px; margin-bottom: 25px;
            background: linear-gradient(155deg, var(--luxury-light), #fdfaf7); box-shadow: var(--shadow-medium);
            transition: opacity var(--transition-speed-med) ease-out, transform var(--transition-speed-med) ease-out, visibility 0s linear var(--transition-speed-med);
            transform: translateX(25px);
        }
        .step.active-step { display: flex; position: relative; opacity: 1; visibility: visible; transform: translateX(0); z-index: 10; transition-delay: 0s; }
        .step.exiting-step { transform: translateX(-25px); visibility: visible; opacity: 0; }
        .step-scrollable-content { padding: 18px 22px; overflow-y: auto; flex-grow: 1; min-height: 0; }
        .step-scrollable-content h2 { font-family: var(--font-heading); color: var(--luxury-brown); text-align: center; font-weight: 700; margin-bottom: 1.4rem; font-size: 1.55em; }
        .step .form-check-input:checked { background-color: var(--luxury-gold); border-color: var(--luxury-gold); }
        .step .form-check-input:focus { box-shadow: 0 0 0 0.15rem rgba(156, 121, 69, 0.25); }
        .step .btn-primary { background: linear-gradient(100deg, var(--luxury-gold), var(--luxury-accent)); color: var(--luxury-light); }
        .button-group { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 22px; border-top: 1px solid rgba(0,0,0,0.05); background-color: #fdfaf7; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; flex-shrink: 0; }
        #quantityStep .prevStep { visibility: hidden; }
        #reviewStep .nextStep { display: none; }
        #quantityStep .button-group { justify-content: flex-end; }
        .sweet-card { border: 1px solid transparent; border-radius: 7px; overflow: hidden; box-shadow: var(--shadow-soft); transition: all var(--transition-speed-fast) ease; background-color: var(--luxury-light); animation: fadeInUp var(--transition-speed-med) ease-out backwards; height: 100%; display: flex; flex-direction: column; max-width: 200px; margin-left: auto; margin-right: auto; }
        .sweet-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-medium); }
        .sweet-card.card-in-cart { border-color: var(--luxury-gold); background-color: #fffdf7; }
        .sweet-card img { width: 100%; aspect-ratio: 16 / 11; object-fit: cover; border-bottom: 1px solid rgba(0,0,0,0.04); background-color: #f8f8f8; cursor: pointer; }
        .sweet-card .card-body { padding: 8px; display: flex; flex-direction: column; flex-grow: 1; }
        .sweet-card .card-title { font-family: var(--font-heading); font-size: 0.9em; color: var(--luxury-brown); margin-bottom: 2px; }
        .sweet-variations { font-size: 0.58em; color: var(--luxury-accent); margin-bottom: 4px; opacity: 0.9; }
        .sweet-card .card-text { font-size: 0.7em; color: #707070; line-height: 1.3; flex-grow: 1; margin-bottom: 5px; max-height: 35px; overflow: hidden; }
        .quantity-control { display: flex; align-items: center; justify-content: space-between; border: 1px solid #e5e5e5; border-radius: 12px; overflow: hidden; background-color: #fff; max-width: 90px; margin: 0 auto 4px; }
        .quantity-control .btn-qty { background-color: #f9f9f9; border: none; color: var(--luxury-brown); font-size: 1.0em; padding: 3px 7px; cursor: pointer; }
        .quantity-control .qty-display { font-size: 0.8em; font-weight: 600; color: var(--brand-dark-brown); padding: 0 4px; min-width: 22px; text-align: center; }
        .sweet-card .quantity-input { display: none !important; }
        .sweet-card .btn-add-update { font-weight: 600; border-radius: 10px; padding: 4px 9px; font-size: 0.62em; width: 100%; margin-top: 6px; text-transform: uppercase; letter-spacing: 0.4px; border: 1px solid transparent; }
        .sweet-card .btn-add { background-color: var(--luxury-brown); color: var(--luxury-light); border-color: var(--luxury-brown); }
        .sweet-card .btn-add:hover { background-color: var(--brand-dark-brown); border-color: var(--brand-dark-brown); }
        .sweet-card .btn-update { background-color: transparent; color: var(--luxury-gold); border: 1px solid var(--luxury-gold); }
        .sweet-card .price-display { font-size: 0.75em; font-weight: bold; color: var(--luxury-gold); margin-top: 4px; margin-bottom: 2px; text-align: center; }

        #cardLoadingOverlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.9); z-index: 20; display: flex; align-items: center; justify-content: center; border-radius: 12px; opacity: 0; visibility: hidden; }
        #cardLoadingOverlay.visible { opacity: 1; visibility: visible; }
        #cardLoadingOverlay .spinner-border { width: 1.8rem; height: 1.8rem; color: var(--luxury-gold); }

        #cartBox {
            position: fixed; bottom: 15px; right: 15px; width: 90%; max-width: 320px;
            max-height: 40vh; background-color: rgba(40, 36, 36, 0.92); color: var(--brand-light-text);
            padding: 10px 12px; z-index: 1050; box-shadow: 0 -3px 15px rgba(0, 0, 0, 0.25);
            border-radius: 8px; border: 1px solid var(--luxury-accent);
            opacity: 0; visibility: hidden; transform: translateY(20px);
            transition: opacity var(--transition-speed-med) ease-out, transform var(--transition-speed-med) ease-out, visibility 0s linear var(--transition-speed-med);
        }
        #cartBox.cart-visible {
            opacity: 1; visibility: visible; transform: translateY(0);
            transition: opacity var(--transition-speed-med) ease-out, transform var(--transition-speed-med) ease-out, visibility 0s linear 0s;
        }
        #cartBox h3 { font-family: var(--font-heading); text-align: center; margin-bottom: 8px; color: var(--luxury-gold); font-size: 1.0em; padding-bottom: 5px; border-bottom: 1px solid rgba(156, 121, 69, 0.2); }
        #cartBox #cartItems { overflow-y: auto; max-height: calc(40vh - 70px); }
        .cart-item, .mobile-cart-item { display: flex; align-items: flex-start; margin-bottom: 7px; border-bottom: 1px solid rgba(156, 121, 69, 0.1); padding-bottom: 7px; position: relative; animation: slideInRight 0.4s ease-out backwards; }
        #cartBox .cart-item img { width: 30px; height: 30px; margin-right: 6px; margin-top:2px; }
        .cart-item img, .mobile-cart-item img { object-fit: cover; border-radius: 4px; background-color: #eee; flex-shrink: 0; }
        .cart-item-details, .mobile-cart-item-details { flex-grow: 1; margin-right: 4px; }
        #cartBox .cart-item-details h5 { font-size: 0.75em; }
        .cart-item-details h5, .mobile-cart-item-details h5 { margin-bottom: 1px; color: var(--brand-light-text); font-weight: 600; }
        #cartBox .cart-item-pricing { font-size: 0.65em; line-height: 1.1; }
        .cart-item-pricing, .mobile-cart-item-pricing { color: var(--brand-light-text); opacity: 0.8; line-height: 1.2; }
        .cart-item-pricing .item-subtotal, .mobile-cart-item-pricing .item-subtotal { font-weight: bold; opacity: 1; }
        #cartBox .cart-item-quantity-controls { margin-left: 5px; }
        .cart-item-quantity-controls { display: flex; align-items: center; margin-left: auto; margin-right: 8px; flex-shrink: 0; }
        .cart-item-quantity-controls .btn-qty-cart { background-color: rgba(255,255,255,0.1); border: none; color: var(--brand-light-text); font-size: 1em; padding: 2px 5px; border-radius: 4px; cursor: pointer; }
        .cart-item-quantity-controls .qty-display-cart { font-size: 0.8em; font-weight: 600; color: var(--brand-light-text); padding: 0 5px; min-width: 20px; text-align: center; }
        #cartBox .remove-item-btn { font-size: 1.0em; }
        .remove-item-btn, .mobile-remove-item-btn { background: none; border: none; color: var(--luxury-accent); cursor: pointer; opacity: 0.7; transition: all var(--transition-speed-fast) ease; align-self: center; flex-shrink: 0; padding:0; margin-left: 5px;}
        .remove-item-btn:hover, .mobile-remove-item-btn:hover { color: var(--luxury-gold); opacity: 1; }
        #cartBox .cart-total-price, #mobileCartModal .cart-total-price { text-align: right; margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(156, 121, 69, 0.2); font-weight: bold; color: var(--luxury-gold); }
        #cartBox .cart-total-price { font-size: 0.85em; }


        #mobileCartModal .modal-content { background-color: var(--brand-dark-bg); color: var(--brand-light-text); border: 1px solid var(--luxury-accent); border-radius: 10px; }
        #mobileCartModal .modal-header { border-bottom: 1px solid rgba(156, 121, 69, 0.2); }
        #mobileCartModal .modal-title { font-family: var(--font-heading); color: var(--luxury-gold); font-size: 1.2em; }
        #mobileCartModal .btn-close { filter: brightness(0) invert(1); }
        #mobileCartModal .modal-body { max-height: 60vh; overflow-y: auto; }
        .mobile-cart-item img {width: 45px; height: 45px; margin-top:2px;}
        #mobileCartModal .cart-total-price { font-size: 1em; }

        #reviewDetails { display: flex; flex-wrap: wrap; gap: 20px; }
        #reviewTextSummary { flex: 1 1 300px; }
        #packagingPreviewContainer { flex: 1 1 250px; }
        #reviewTextSummary .list-group-item { background-color: transparent; border-color: rgba(0,0,0,0.04); padding: 6px 0px; font-size: 0.85em;}
        #reviewTextSummary h4 { font-family: var(--font-heading); color: var(--luxury-brown); margin-bottom: 0.8rem; font-size: 1.2em; border-bottom: 1px solid rgba(0,0,0,0.07); padding-bottom: 0.4rem; }
        #reviewTextSummary .price-value { font-weight: 600; color: var(--brand-dark-brown); }
        #reviewTextSummary .total-line strong { color: var(--luxury-brown); font-weight: 700;}
        #reviewTextSummary .grand-total strong { color: var(--luxury-gold); font-size: 1.15em; }
        #visualBoxRepresentation { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; padding: 10px; border-radius: 5px; min-height: 150px; align-content: flex-start;}
        #visualBoxRepresentation.visual-box { background-color: #fffcf5; border: 1.5px solid var(--luxury-brown); }
        #visualBoxRepresentation.visual-tray { background: linear-gradient(135deg, #ecdcc6, #d7c497); border: 1.5px dashed var(--luxury-gold); }
        .sweet-icon-placeholder { text-align: center; display: flex; flex-direction: column; align-items: center; animation: fadeInUp 0.4s ease-out backwards; }
        .sweet-icon-placeholder img { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; border: 1.5px solid var(--luxury-accent); box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 4px; background-color: #eee; }
        .sweet-icon-placeholder span { display: block; font-size: 0.7em; font-weight: 600; color: var(--brand-dark-brown); line-height: 1.15; max-width: 100%; word-wrap: break-word; }
        #emptyBoxVisualMsg { grid-column: 1 / -1; text-align: center; padding: 15px; color: var(--luxury-brown); font-style: italic; opacity: 0.7; font-size: 0.75em; }

        #orderSuccessMessage #successOrderSummary p { margin-bottom: 4px;}
        #orderSuccessMessage #successOrderSummary strong { color: var(--luxury-brown); }
        .footer { background-color: var(--brand-dark-bg); color: rgba(255,255,255,0.7); padding: 1.5rem 1rem 1rem; margin-top: 2rem; font-size: 0.85em; text-align: center; border-top: 2px solid var(--brand-gold); }
        .footer .social-icons a { color: rgba(255,255,255,0.7); font-size: 1.4rem; margin: 0 0.6rem; }
        .footer .social-icons a:hover { color: var(--brand-gold); }
        .footer .contact-info a { color: rgba(255,255,255,0.7); }
        .footer .contact-info a:hover { color: var(--brand-gold); }

        @media (max-width: 767.98px) {
            body { padding-top: 70px; }
            .navbar-collapse { position: fixed; top: 70px; right: 0; left: 0; background-color: rgba(var(--bs-dark-rgb),0.98); backdrop-filter: blur(6px); padding: 1rem; box-shadow: 0 8px 15px rgba(0,0,0,0.25); border-radius: 0 0 8px 8px; z-index: 1040; border-top: 1px solid rgba(255,255,255,0.1); }
            #nav-cart-indicator { display: inline-block; }
            .button-group { flex-direction: column; gap: 8px; align-items: stretch; }
            .button-group .prevStep { order: 2; }
            .button-group .nextStep, .button-group #finishOrder, .button-group #confirmOrderBtn { order: 1; width: 100%; }
            #quantityStep .button-group { flex-direction: row; justify-content: flex-end; }
            #quantityStep .button-group .prevStep { display: none; }
            #cartBox { display: none !important; } /* Hide floating cart on mobile, use modal */
            #reviewDetails { flex-direction: column; }
            #reviewTextSummary, #packagingPreviewContainer { flex-basis: auto; }
        }
        @media (max-width: 575.98px) {
            #wizard-progress { display: none; }
            .sweet-card { max-width: 100%; }
            #sweetCards.row { --bs-gutter-x: 0.5rem; --bs-gutter-y: 0.5rem; }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html#landing">
                <img src="img/logo-no-background.png" alt="Darna Logo"
                     onerror="this.style.display='none'; const el = document.createElement('span'); el.className='navbar-brand-text-fallback'; el.textContent='Darna'; this.parentNode.insertBefore(el, this.nextSibling); console.error('Logo Error: img/logo-no-background.png')">
            </a>
            <div class="navbar-controls d-flex align-items-center d-lg-none">
                 <a href="#" id="nav-cart-indicator" class="nav-link" data-bs-toggle="modal" data-bs-target="#mobileCartModal" aria-label="View Selections">
                    <i class="bi bi-box-seam"></i><span class="badge">0</span>
                 </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            </div>
             <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                 <ul class="navbar-nav">
                     <li class="nav-item"><a class="nav-link" href="index.html#landing">Home</a></li>
                     <li class="nav-item"><a class="nav-link active" aria-current="page" href="custom-order.html">Offerings</a></li>
                     <li class="nav-item"><a class="nav-link" href="index.html#initiatives">Initiatives</a></li>
                     <li class="nav-item"><a class="nav-link" href="index.html#contact">Contact Us</a></li>
                 </ul>
             </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container main-container">
        <h1 class="main-title">Compose Your Exquisite Sweet Box</h1>
         <div class="text-center mb-3"> <!-- Optional: Button to clear cart -->
            <button id="clearAndStartNewOrderBtn" class="btn btn-outline-secondary btn-sm">Clear Selections & Start New Box</button>
        </div>
        <div id="errorMessage" style="display: none;"><h4>Oops!</h4><p></p></div>
        <div id="wizardContainer">
            <div id="wizard-progress">
                <div class="progress-step" data-step="0"><span>1.</span><span class="step-text">Preference</span></div>
                <div class="progress-step" data-step="1"><span>2.</span><span class="step-text">Delicacies</span></div>
                <div class="progress-step" data-step="2"><span>3.</span><span class="step-text">Presentation</span></div>
                <div class="progress-step" data-step="3"><span>4.</span><span class="step-text">Review</span></div>
            </div>
            <div id="wizard">
                <div id="quantityStep" class="step">
                    <div class="step-scrollable-content">
                         <h2>Choose Your Preference</h2>
                         <div class="form-check"><input class="form-check-input" type="radio" name="quantityType" id="quantityUnit" value="unit" checked><label class="form-check-label" for="quantityUnit">Order by Unit</label></div>
                         <div class="form-check"><input class="form-check-input" type="radio" name="quantityType" id="quantityWeight" value="weight"><label class="form-check-label" for="quantityWeight">Order by Weight (grams)</label></div>
                    </div>
                     <div class="button-group">
                        <button type="button" class="btn btn-secondary prevStep">Back</button>
                        <button type="button" class="btn btn-primary nextStep">Next: Delicacies</button>
                    </div>
                </div>
                <div id="sweetSelectionStep" class="step">
                    <div class="step-scrollable-content">
                        <h2>Select Your Delicacies</h2>
                        <div id="cardLoadingOverlay"><div class="spinner-border"><span class="visually-hidden">Loading...</span></div></div>
                        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-2 g-md-3 justify-content-center" id="sweetCards">
                            <p class="text-muted text-center col-12">Loading delicacies...</p>
                        </div>
                    </div>
                     <div class="button-group">
                         <button type="button" class="btn btn-secondary prevStep">Back</button>
                         <button type="button" class="btn btn-primary nextStep">Next</button>
                     </div>
                </div>
                <div id="packagingStep" class="step">
                     <div class="step-scrollable-content">
                         <h2>Choose Presentation</h2>
                         <div class="form-check"><input class="form-check-input" type="radio" name="packaging" id="box" value="box" checked><label class="form-check-label" for="box">Signature Darna Box</label></div>
                         <div class="form-check"><input class="form-check-input" type="radio" name="packaging" id="tray" value="tray"><label class="form-check-label" for="tray">Ornate Keepsake Tray (+30 MAD)</label></div>
                     </div>
                     <div class="button-group">
                        <button type="button" class="btn btn-secondary prevStep">Back</button>
                        <button type="button" class="btn btn-primary" id="finishOrder">Next</button>
                    </div>
                </div>
                 <div id="reviewStep" class="step">
                    <div class="step-scrollable-content">
                        <h2>Review Your Creation</h2>
                        <div id="reviewDetails">
                            <div id="reviewTextSummary">
                                <!-- Content generated by JS -->
                            </div>
                            <div id="packagingPreviewContainer">
                                 <h5>Visual Preview</h5>
                                 <div id="visualBoxRepresentation">
                                     <!-- Content generated by JS -->
                                 </div>
                            </div>
                        </div>
                         <div class="alert alert-light border-warning mt-3 small py-2" style="background-color: #fffaf0;"><i class="bi bi-info-circle-fill text-warning me-1"></i>Please review. Demo only.</div>
                    </div>
                     <div class="button-group">
                         <button type="button" class="btn btn-secondary prevStep">Back</button>
                         <button type="button" class="btn btn-success" id="confirmOrderBtn"><i class="bi bi-whatsapp me-1"></i>Send Order via WhatsApp</button>
                     </div>
                </div>
            </div>
        </div>
         <!-- Success Message is no longer used in the primary flow after "Confirm" -->
         <div id="orderSuccessMessage" style="display: none;">
              <h2><i class="bi bi-patch-check-fill"></i> Order Confirmed! (Demo)</h2>
              <p>Your selection is noted. Thank you!</p>
              <div id="successOrderSummary"></div>
              <button id="startNewOrderBtn" class="btn-new-order mt-3">Compose Another</button>
         </div>
    </main>

    <!-- Floating Cart for Desktop -->
    <div id="cartBox"> <!-- Initially hidden by CSS opacity/visibility/transform -->
        <h3>Your Bespoke Box</h3>
        <div id="cartItems">
            <p id="emptyCartMsg" class="empty-cart-placeholder">Awaits selections.</p>
        </div>
    </div>

    <div class="modal fade" id="mobileCartModal" tabindex="-1" aria-labelledby="mobileCartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="mobileCartModalLabel">Your Selections</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="mobileCartItems"><p id="emptyMobileCartMsg" class="empty-cart-placeholder">Awaits selections.</p></div>
                <div class="modal-footer"><button type="button" class="btn btn-primary btn-modal-action" data-bs-dismiss="modal">Continue Building</button></div>
            </div>
        </div>
    </div>
    <footer class="footer text-center">
        <div class="container">
            <div class="social-icons mb-3">
                <a href="https://www.instagram.com/darna_patisserie?igsh=MTRwcTNtcWkyM3Q4OA==" target="_blank" rel="noopener noreferrer"><i class="bi bi-instagram"></i></a>
                <a href="https://www.facebook.com/profile.php?id=61575057266959" target="_blank" rel="noopener noreferrer"><i class="bi bi-facebook"></i></a>
            </div>
            <div class="contact-info mb-2"><a href="mailto:darnapatisserie@gmail.com"><i class="bi bi-envelope-fill me-1"></i>darnapatisserie@gmail.com</a></div>
            <p>Â© <span id="currentYear"></span> Darna Patisserie. All Rights Reserved.</p>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        try {
            $(document).ready(function() {
                const WHATSAPP_NUMBER = "+212708898226"; // <<< REPLACE THIS WITH YOUR ACTUAL WHATSAPP NUMBER (e.g., "212600000000")
                console.log("Darna Wizard (v16 - WhatsApp Direct Order)...");

                let cart = [], currentStep = 0, sweets = [], chosenQuantityType = 'unit', chosenPackaging = 'box';
                const packagingCost = { box: 0, tray: 30.00 };
                const CURRENCY_SYMBOL = " MAD";

                const $steps = $(".step"), $progressSteps = $(".progress-step"), $wizardContainer = $("#wizardContainer"),
                      $successMessage = $("#orderSuccessMessage"), $cardLoadingOverlay = $("#cardLoadingOverlay"),
                      $cartBox = $("#cartBox"), $cartItemsContainer = $("#cartItems"), $emptyCartMsg = $("#emptyCartMsg"),
                      $sweetCardsContainer = $("#sweetCards"), $errorMessage = $("#errorMessage"),
                      $navCartIndicator = $("#nav-cart-indicator"), $navCartBadge = $navCartIndicator.find(".badge"),
                      mobileCartModalEl = document.getElementById('mobileCartModal'),
                      mobileCartModal = mobileCartModalEl ? new bootstrap.Modal(mobileCartModalEl) : null,
                      $mobileCartItemsContainer = $("#mobileCartItems"), $emptyMobileCartMsg = $("#emptyMobileCartMsg");

                const placeholderImg = 'img/New img/placeholder_sweet.jpg';

                function getSweetById(id) { return sweets.find(s => s.id === id) || null; }
                function formatQuantity(qty, type) { return type === 'unit' ? `${qty} pc${qty !== 1 ? 's' : ''}` : `${qty}g`; }
                function formatPrice(price) { return parseFloat(price).toFixed(2) + CURRENCY_SYMBOL; }
                function updateCurrentYear() { $('#currentYear').text(new Date().getFullYear()); }

                function calculateItemTotal(item) {
                    const price = item.quantityType === 'unit' ? item.price_per_unit_mad : item.price_per_100g_mad;
                    if (typeof price !== 'number' || typeof item.quantity !== 'number') return 0;
                    return item.quantityType === 'unit' ? item.quantity * price : (item.quantity / 100) * price;
                }
                function calculateCartTotal() { return cart.reduce((total, item) => total + item.itemTotal, 0); }
                function updateNavbarCartIndicator() {
                    const count = cart.reduce((sum, item) => sum + (item.quantityType === 'unit' ? item.quantity : 1), 0);
                    $navCartBadge.text(count > 0 ? count : '0').toggle(count > 0);
                }

                function renderCartItems(container, emptyMsgEl, isMobile) {
                    container.find('.cart-item, .mobile-cart-item, .cart-total-price, .empty-cart-placeholder').remove();
                    if (cart.length === 0) {
                        container.append(emptyMsgEl.clone().removeAttr('id').addClass('empty-cart-placeholder').show());
                        if (!isMobile) $cartBox.removeClass('cart-visible');
                    } else {
                        cart.forEach((item, idx) => {
                            const priceValue = item.quantityType === 'unit' ? item.price_per_unit_mad : item.price_per_100g_mad;
                            const priceSuffix = item.quantityType === 'unit' ? 'per unit' : 'per 100g';
                            container.append(`
                                <div class="${isMobile ? 'mobile-' : ''}cart-item" style="animation-delay:${idx*0.05}s" data-sweet-id="${item.sweetId}" data-quantity-type="${item.quantityType}">
                                    <img src="${item.img || placeholderImg}" alt="${item.name}" onerror="this.onerror=null; this.src='${placeholderImg}'">
                                    <div class="${isMobile ? 'mobile-' : ''}cart-item-details">
                                        <h5>${item.name}</h5>
                                        <div class="${isMobile ? 'mobile-' : ''}cart-item-pricing">
                                            <span>${formatPrice(priceValue)} ${priceSuffix}</span><br>
                                            <span class="item-subtotal">Item Total: ${formatPrice(item.itemTotal)}</span>
                                        </div>
                                    </div>
                                    <div class="cart-item-quantity-controls">
                                        <button class="btn-qty-cart btn-qty-decrease-cart" data-action="decrease">-</button>
                                        <span class="qty-display-cart">${item.quantity}</span>
                                        <button class="btn-qty-cart btn-qty-increase-cart" data-action="increase">+</button>
                                    </div>
                                    <button class="${isMobile ? 'mobile-' : ''}remove-item-btn">Ã—</button>
                                </div>`);
                        });
                        container.append(`<div class="cart-total-price">Box Total: ${formatPrice(calculateCartTotal())}</div>`);
                        if (!isMobile && currentStep < 3 && cart.length > 0) $cartBox.addClass('cart-visible');
                        else if (!isMobile) $cartBox.removeClass('cart-visible');
                    }
                }
                function updateAllCartDisplays() {
                    renderCartItems($cartItemsContainer, $emptyCartMsg, false);
                    updateNavbarCartIndicator();
                    if (mobileCartModalEl && bootstrap.Modal.getInstance(mobileCartModalEl)?.isShown) {
                        renderCartItems($mobileCartItemsContainer, $emptyMobileCartMsg, true);
                    }
                }

                function updateWizardProgress(idx) { $progressSteps.each((i, el) => $(el).removeClass('active completed').toggleClass('completed', i < idx).toggleClass('active', i === idx)); }
                function showStep(idx) {
                    if (idx < 0 || idx >= $steps.length) return;
                    const $currActive = $steps.filter('.active-step'), $next = $($steps[idx]);
                    if ($currActive.length && $currActive[0] !== $next[0]) {
                        $currActive.removeClass('active-step').addClass('exiting-step');
                        setTimeout(() => $currActive.removeClass('exiting-step'), 500);
                    }
                    $next.removeClass('exiting-step'); setTimeout(() => $next.addClass('active-step'), 10);
                    const prevStep = currentStep; currentStep = idx; updateWizardProgress(currentStep);

                    if (cart.length > 0 && currentStep < 3) { $cartBox.addClass('cart-visible'); }
                    else { $cartBox.removeClass('cart-visible'); }

                    if (currentStep === 1 && (prevStep !== 1 || $sweetCardsContainer.children().length <= 1 || $sweetCardsContainer.find('.quantity-input').first().attr('step') !== (chosenQuantityType === 'unit' ? '1' : '10'))) {
                        $cardLoadingOverlay.addClass('visible');
                        setTimeout(() => { generateSweetCards(); $cardLoadingOverlay.removeClass('visible'); }, 50);
                    } else if (currentStep === 1) updateAllCardStates();
                    else if (currentStep === 3) populateReview();
                }

                function generateSweetCards() {
                    $sweetCardsContainer.empty(); if (!sweets.length) { $sweetCardsContainer.append('<p class="text-center text-danger col-12">No delicacies found.</p>'); return; }
                    const minQuantity = chosenQuantityType === 'unit' ? 1 : 50;
                    const stepQuantity = chosenQuantityType === 'unit' ? 1 : 10;
                    const priceSuffix = chosenQuantityType === 'unit' ? 'per unit' : 'per 100g';

                    sweets.forEach((sweet, index) => {
                        const sweetPrice = chosenQuantityType === 'unit' ? sweet.price_per_unit_mad : sweet.price_per_100g_mad;
                        const displayPrice = typeof sweetPrice === 'number' ? sweetPrice : 0;

                        const existingCartItem = cart.find(item => item.sweetId === sweet.id && item.quantityType === chosenQuantityType);
                        const isInCart = !!existingCartItem;
                        const currentQuantity = isInCart ? existingCartItem.quantity : minQuantity;
                        const imagePath = sweet.img || placeholderImg;

                        $sweetCardsContainer.append(`
                            <div class="sweet-card-column">
                                <div class="card sweet-card ${isInCart ? 'card-in-cart' : ''}" style="animation-delay:${index*0.04}s" data-sweet-id="${sweet.id}">
                                    <img src="${imagePath}" class="card-img-top selectable-card-img" alt="${sweet.name}" onerror="this.onerror=null; this.src='${placeholderImg}'">
                                    <div class="card-body">
                                        <h5 class="card-title">${sweet.name}</h5>
                                        ${sweet.variations && sweet.variations.length ? `<div class="sweet-variations"><i class="bi bi-dot"></i> ${sweet.variations[0]}${sweet.variations.length > 1 ? ' (+)' : ''}</div>` : ''}
                                        <p class="card-text">${sweet.description}</p>
                                        <div class="price-display">${formatPrice(displayPrice)} ${priceSuffix}</div>
                                        <div class="form-group mt-auto">
                                            <div class="quantity-control-wrapper mb-2">
                                                 <div class="quantity-control">
                                                      <button type="button" class="btn-qty btn-qty-decrease" data-action="decrease">-</button>
                                                      <span class="qty-display">${currentQuantity}</span>
                                                      <button type="button" class="btn-qty btn-qty-increase" data-action="increase">+</button>
                                                 </div>
                                                 <input type="number" class="quantity-input" value="${currentQuantity}" min="${minQuantity}" step="${stepQuantity}">
                                             </div>
                                             <button class="btn btn-sm btn-add-update ${isInCart ? 'btn-update' : 'btn-add'}" data-unit-price="${displayPrice}">${isInCart ? 'Update' : 'Add'}</button>
                                         </div>
                                    </div>
                                </div>
                            </div>`);
                    });
                 }
                function updateCardState(sweetId) {
                    const card = $sweetCardsContainer.find(`.sweet-card[data-sweet-id="${sweetId}"]`);
                    if (!card.length) return;
                    const sweetData = getSweetById(sweetId);
                    if (!sweetData) return;

                    const sweetPrice = chosenQuantityType === 'unit' ? sweetData.price_per_unit_mad : sweetData.price_per_100g_mad;
                    const displayPrice = typeof sweetPrice === 'number' ? sweetPrice : 0;
                    const priceSuffix = chosenQuantityType === 'unit' ? 'per unit' : 'per 100g';
                    card.find('.price-display').text(`${formatPrice(displayPrice)} ${priceSuffix}`);
                    card.find('.btn-add-update').data('unit-price', displayPrice);

                    const existingCartItem = cart.find(item => item.sweetId === sweetId && item.quantityType === chosenQuantityType);
                    const isInCart = !!existingCartItem;
                    const button = card.find('.btn-add-update');
                    const quantityInput = card.find('.quantity-input');
                    const quantityDisplay = card.find('.qty-display');
                    const minQuantity = chosenQuantityType === 'unit' ? 1 : 50;

                    quantityInput.attr('min', minQuantity).attr('step', chosenQuantityType === 'unit' ? 1 : 10);

                    if (isInCart) {
                        card.addClass('card-in-cart'); button.removeClass('btn-add').addClass('btn-update').text('Update');
                        quantityInput.val(existingCartItem.quantity); quantityDisplay.text(existingCartItem.quantity);
                    } else {
                        card.removeClass('card-in-cart'); button.removeClass('btn-update').addClass('btn-add').text('Add');
                        quantityInput.val(minQuantity); quantityDisplay.text(minQuantity);
                    }
                 }
                 function updateAllCardStates() { $sweetCardsContainer.find(".sweet-card").each(function() { updateCardState($(this).data('sweet-id')); }); }

                $(".nextStep").click(function() {
                    let canProceed = true;
                    if (currentStep === 0) {
                        const newType = $('input[name="quantityType"]:checked').val();
                        if (newType !== chosenQuantityType && cart.length && !confirm("Change preference clears selections. Proceed?")) {
                             $(`input[name="quantityType"][value="${chosenQuantityType}"]`).prop('checked', true); canProceed = false;
                        } else if (newType !== chosenQuantityType) { cart = []; chosenQuantityType = newType; updateAllCartDisplays(); }
                    } else if (currentStep === 1 && !cart.length) { alert("Box is empty!"); canProceed = false; }
                    else if (currentStep === 2) {
                         chosenPackaging = $('input[name="packaging"]:checked').val();
                         if (!chosenPackaging) { alert("Select presentation."); canProceed = false; }
                    }
                    if (canProceed && currentStep < $steps.length - 1) showStep(currentStep + 1);
                });
                $(".prevStep").click(function() { if (currentStep > 0) showStep(currentStep - 1); });
                $(document).on('click', '#wizard-progress .progress-step.completed', function() { const step = parseInt($(this).data('step')); if (!isNaN(step) && step < currentStep) showStep(step); });
                $(document).on('click', '.selectable-card-img', function() { $(this).closest('.sweet-card').find('.btn-add-update').trigger('click'); });
                $sweetCardsContainer.on('click', '.btn-qty', function() {
                    const $btn = $(this), action = $btn.data('action'), $group = $btn.closest('.form-group'),
                          $input = $group.find('.quantity-input'), $display = $group.find('.qty-display');
                    let val = parseInt($input.val()), min = parseInt($input.attr('min')), step = parseInt($input.attr('step'));
                    val = (action === 'increase') ? val + step : Math.max(min, val - step);
                    $input.val(val); $display.text(val); $group.find('.btn-add-update').trigger('click');
                });

                $(document).on("click", ".btn-add-update", function() {
                    const $button = $(this), sweetCard = $button.closest('.sweet-card'), sweetId = sweetCard.data('sweet-id'),
                          sweetData = getSweetById(sweetId);
                    if (!sweetData) { console.error("Sweet data not found for ID:", sweetId); return; }

                    const unitPrice = parseFloat($button.data('unit-price'));
                    let quantity = parseInt(sweetCard.find('.quantity-input').val());
                    const minQuantity = parseInt(sweetCard.find('.quantity-input').attr('min'));

                    if (isNaN(quantity) || quantity < minQuantity || isNaN(unitPrice)) {
                        quantity = minQuantity; sweetCard.find('.quantity-input').val(quantity);
                        sweetCard.find('.qty-display').text(quantity);
                    }
                    const existingIdx = cart.findIndex(i => i.sweetId === sweetId && i.quantityType === chosenQuantityType);
                    const cartItemData = {
                        sweetId, name: sweetData.name, quantity, quantityType: chosenQuantityType,
                        img: sweetData.img, price_per_unit_mad: sweetData.price_per_unit_mad, price_per_100g_mad: sweetData.price_per_100g_mad
                    };
                    cartItemData.itemTotal = calculateItemTotal(cartItemData);

                    if (existingIdx > -1) cart[existingIdx] = cartItemData;
                    else {
                        cart = cart.filter(i => !(i.sweetId === sweetId && i.quantityType !== chosenQuantityType));
                        cart.push(cartItemData);
                    }
                    $button.addClass('added-pulse'); setTimeout(() => $button.removeClass('added-pulse'), 400);
                    updateAllCartDisplays(); updateAllCardStates();
                });

                function handleCartItemQuantityChange(btnEl, action) {
                    const $cartItem = $(btnEl).closest('[data-sweet-id]'), sweetId = $cartItem.data('sweet-id'), type = $cartItem.data('quantity-type'),
                          cartIdx = cart.findIndex(i => i.sweetId === sweetId && i.quantityType === type);
                    if (cartIdx === -1) return;
                    let qty = cart[cartIdx].quantity;
                    const min = type === 'unit' ? 1 : 50, step = type === 'unit' ? 1 : 10;
                    qty = (action === 'increase') ? qty + step : qty - step;
                    if (qty < min) {
                        cart.splice(cartIdx, 1); $cartItem.addClass('removing');
                        setTimeout(() => { updateAllCartDisplays(); updateAllCardStates(); }, 350); return;
                    }
                    cart[cartIdx].quantity = qty; cart[cartIdx].itemTotal = calculateItemTotal(cart[cartIdx]);
                    updateAllCartDisplays(); updateCardState(sweetId);
                }
                $(document).on('click', '.btn-qty-decrease-cart', function() { handleCartItemQuantityChange(this, 'decrease'); });
                $(document).on('click', '.btn-qty-increase-cart', function() { handleCartItemQuantityChange(this, 'increase'); });
                $(document).on('click', '.remove-item-btn, .mobile-remove-item-btn', function() {
                    const $item = $(this).closest('[data-sweet-id]'), id = $item.data('sweet-id'), type = $item.data('quantity-type');
                    $item.addClass('removing');
                    setTimeout(() => {
                        cart = cart.filter(i => !(i.sweetId === id && i.quantityType === type));
                        updateAllCartDisplays(); updateAllCardStates();
                    }, 350);
                });

                if (mobileCartModalEl) mobileCartModalEl.addEventListener('show.bs.modal', () => renderCartItems($mobileCartItemsContainer, $emptyMobileCartMsg, true));
                $("#finishOrder").click(function() { chosenPackaging = $('input[name="packaging"]:checked').val(); if (chosenPackaging) showStep(3); else alert("Select presentation."); });

                function populateReview() {
                    const reviewTextSummary = $("#reviewTextSummary");
                    const visualBox = $("#visualBoxRepresentation");
                    reviewTextSummary.empty(); visualBox.empty();

                    let summaryHtml = `<h4>Selections:</h4><ul class="list-group list-group-flush mb-3">`;
                    let sweetsSubtotal = 0;
                    if (cart.length > 0) {
                        cart.forEach(item => {
                            sweetsSubtotal += item.itemTotal;
                            summaryHtml += `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>${item.name} <small>(${formatQuantity(item.quantity, item.quantityType)})</small></span>
                                    <span class="price-value">${formatPrice(item.itemTotal)}</span>
                                </li>`;
                        });
                    } else {
                        summaryHtml += `<li class="list-group-item">No delicacies selected yet.</li>`;
                    }
                    summaryHtml += `</ul>`;

                    const packagingName = chosenPackaging === 'box' ? 'Signature Darna Box' : 'Ornate Keepsake Tray';
                    const packagingPrice = packagingCost[chosenPackaging];
                    const grandTotal = sweetsSubtotal + packagingPrice;

                    summaryHtml += `<h4>Presentation & Totals:</h4><ul class="list-group list-group-flush">`;
                    summaryHtml += `<li class="list-group-item d-flex justify-content-between align-items-center total-line">Style<span>${packagingName}</span></li>`;
                    summaryHtml += `<li class="list-group-item d-flex justify-content-between align-items-center total-line">Sweets Subtotal<span class="price-value">${formatPrice(sweetsSubtotal)}</span></li>`;
                    if (packagingPrice > 0) {
                        summaryHtml += `<li class="list-group-item d-flex justify-content-between align-items-center total-line">Packaging Cost<span class="price-value">${formatPrice(packagingPrice)}</span></li>`;
                    }
                    summaryHtml += `<li class="list-group-item d-flex justify-content-between align-items-center grand-total"><strong>Grand Total</strong><strong>${formatPrice(grandTotal)}</strong></li>`;
                    summaryHtml += `</ul><p class="mt-3 fst-italic text-muted small">Note: Pricing shown is indicative for this demo.</p>`;
                    reviewTextSummary.html(summaryHtml);

                    visualBox.removeClass('visual-box visual-tray').addClass(chosenPackaging === 'box' ? 'visual-box' : 'visual-tray');
                    if (cart.length > 0) {
                        let iconCounter = 0;
                        cart.forEach(item => {
                            const delay = iconCounter * 0.04;
                            const itemImagePath = item.img || placeholderImg;
                            const fullLabel = `${item.name} (${formatQuantity(item.quantity, item.quantityType)})`;
                            visualBox.append(
                                `<div class="sweet-icon-placeholder" style="animation-delay: ${delay}s;" title="${item.name} - ${formatQuantity(item.quantity, item.quantityType)}">
                                    <img src="${itemImagePath}" alt="${item.name}" onerror="this.onerror=null; this.src='${placeholderImg}'; this.alt='Img missing';">
                                    <span>${fullLabel}</span>
                                </div>`
                            );
                            iconCounter++;
                        });
                    } else {
                        visualBox.html('<p id="emptyBoxVisualMsg" class="col-12">Your presentation awaits your selections!</p>');
                    }
                 }

                $("#confirmOrderBtn").click(function() {
                    const $button = $(this);
                    if ($button.prop('disabled')) return;
                    $button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Preparing Order...');

                    let orderDetailsForWhatsApp = "Salam Darna Patisserie! I would like to place the following custom order:\n\n";
                    let sweetsSubtotal = 0;

                    if (cart.length > 0) {
                        orderDetailsForWhatsApp += "*DELICACIES:*\n";
                        cart.forEach(item => {
                            const itemPrice = item.quantityType === 'unit' ? item.price_per_unit_mad : item.price_per_100g_mad;
                            const priceSuffix = item.quantityType === 'unit' ? 'per unit' : 'per 100g';
                            orderDetailsForWhatsApp += `- ${item.name}: ${formatQuantity(item.quantity, item.quantityType)} (${formatPrice(itemPrice)} ${priceSuffix}) - Item Total: ${formatPrice(item.itemTotal)}\n`;
                            sweetsSubtotal += item.itemTotal;
                        });
                        orderDetailsForWhatsApp += `\n*Sweets Subtotal:* ${formatPrice(sweetsSubtotal)}\n`;
                    } else {
                        orderDetailsForWhatsApp += "No delicacies selected in this custom box.\n";
                    }
                    const packagingName = chosenPackaging === 'box' ? 'Signature Darna Box' : 'Ornate Keepsake Tray';
                    const finalPackagingCost = packagingCost[chosenPackaging];
                    const grandTotal = sweetsSubtotal + finalPackagingCost;
                    orderDetailsForWhatsApp += `\n*PRESENTATION:*\n- Style: ${packagingName}`;
                    if (finalPackagingCost > 0) { orderDetailsForWhatsApp += ` (${formatPrice(finalPackagingCost)})`; }
                    orderDetailsForWhatsApp += `\n\n*GRAND TOTAL:* ${formatPrice(grandTotal)}\n\n`;
                    orderDetailsForWhatsApp += "Please confirm availability and next steps.\nThank you!";

                    if (WHATSAPP_NUMBER === "212YOURPHONENUMBER" || !WHATSAPP_NUMBER) { // Added !WHATSAPP_NUMBER
                        alert("WhatsApp number is not configured. Please contact support or the developer.");
                        $button.prop('disabled', false).html('<i class="bi bi-whatsapp me-1"></i>Send Order via WhatsApp');
                        return;
                    }
                    const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(orderDetailsForWhatsApp)}`;
                    console.log("WhatsApp URL:", whatsappUrl);
                    $wizardContainer.fadeOut(200); $cartBox.removeClass('cart-visible');
                    window.location.href = whatsappUrl;
                    setTimeout(() => {
                        $button.prop('disabled', false).html('<i class="bi bi-whatsapp me-1"></i>Send Order via WhatsApp');
                        // $wizardContainer.fadeIn(200); // Optional: bring wizard back if redirect fails.
                        // Consider if resetOrderProcess() should be called here or if user explicitly starts new.
                    }, 3000);
                });

                function resetOrderProcess() {
                    console.log("Resetting order process...");
                    cart = []; currentStep = 0; chosenQuantityType = 'unit'; chosenPackaging = 'box';
                    $('input[name="quantityType"][value="unit"]').prop('checked', true);
                    $('input[name="packaging"][value="box"]').prop('checked', true);
                    updateAllCartDisplays();
                    $successMessage.hide(); $wizardContainer.show(); showStep(0);
                    if (sweets && sweets.length > 0) { updateAllCardStates(); }
                    $('html, body').animate({ scrollTop: 0 }, 500);
                }
                $("#clearAndStartNewOrderBtn").click(function() {
                    if (confirm("Clear selections and start a new box?")) { resetOrderProcess(); }
                });
                $("#startNewOrderBtn").click(resetOrderProcess); // For the (now unused) success screen button


                function initializeApp() {
                    $errorMessage.hide(); $wizardContainer.show(); $successMessage.hide(); $cardLoadingOverlay.removeClass('visible');
                    updateCurrentYear(); updateNavbarCartIndicator(); showStep(0); updateAllCartDisplays();
                }

                fetch('sweets.json')
                    .then(response => { if (!response.ok) throw new Error(`HTTP error! ${response.status}`); return response.json(); })
                    .then(data => {
                        if (!Array.isArray(data)) throw new Error("sweets.json not an array.");
                        data.forEach(s => {
                            if (typeof s.price_per_unit_mad !== 'number') { s.price_per_unit_mad = 0; }
                            if (typeof s.price_per_100g_mad !== 'number') { s.price_per_100g_mad = 0; }
                        });
                        sweets = data; initializeApp();
                    })
                    .catch(error => {
                        console.error("Sweet Data Load/Parse ERROR:", error);
                        $errorMessage.find('p').first().html(`<strong>${error.message}</strong><br>Ensure 'sweets.json' is valid and prices are correct. Image paths should be like 'img/New img/your_image.jpg'. Refresh page.`);
                        $errorMessage.show(); $wizardContainer.hide(); $cardLoadingOverlay.removeClass('visible');
                    });
            });
        } catch (error) { console.error("CRITICAL SCRIPT ERROR:", error); alert('Critical error. Check console (F12) & Refresh.'); }
    </script>
</body>
</html>